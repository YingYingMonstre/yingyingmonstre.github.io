<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Boofuzz源码分析 | 银河之家</title><meta name="keywords" content="Fuzzing"><meta name="author" content="银河"><meta name="copyright" content="银河"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Boofuzz样例以一个TFTP Fuzzer为例，大概看一下Boofuzz的用法。 123456789101112131415161718from boofuzz import *import timedef main():    session &#x3D; Session(sleep_time&#x3D;1,                      target&#x3D;Target(connection&#x3D;Socke">
<meta property="og:type" content="article">
<meta property="og:title" content="Boofuzz源码分析">
<meta property="og:url" content="https://yingyingmonstre.github.io/2022/03/22/Boofuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="银河之家">
<meta property="og:description" content="Boofuzz样例以一个TFTP Fuzzer为例，大概看一下Boofuzz的用法。 123456789101112131415161718from boofuzz import *import timedef main():    session &#x3D; Session(sleep_time&#x3D;1,                      target&#x3D;Target(connection&#x3D;Socke">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p0.ssl.qhimg.com/t01f9ade5a46c467768.png">
<meta property="article:published_time" content="2022-03-22T02:00:00.000Z">
<meta property="article:modified_time" content="2022-08-09T08:40:03.187Z">
<meta property="article:author" content="银河">
<meta property="article:tag" content="Fuzzing">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p0.ssl.qhimg.com/t01f9ade5a46c467768.png"><link rel="shortcut icon" href="/yingyingmonstre.github.io/img/favicon.png"><link rel="canonical" href="https://yingyingmonstre.github.io/2022/03/22/Boofuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/yingyingmonstre.github.io/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/yingyingmonstre.github.io/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-08-09 16:40:03'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="../css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="../../css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="../../../../css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/yingyingmonstre.github.io/atom.xml" title="银河之家" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/yingyingmonstre.github.io/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/yingyingmonstre.github.io/archives/"><div class="headline">文章</div><div class="length-num">6</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/yingyingmonstre.github.io/tags/"><div class="headline">标签</div><div class="length-num">5</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/yingyingmonstre.github.io/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/yingyingmonstre.github.io/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/yingyingmonstre.github.io/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/yingyingmonstre.github.io/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/yingyingmonstre.github.io/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/yingyingmonstre.github.io/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://p0.ssl.qhimg.com/t01f9ade5a46c467768.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/yingyingmonstre.github.io/">银河之家</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/yingyingmonstre.github.io/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/yingyingmonstre.github.io/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/yingyingmonstre.github.io/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/yingyingmonstre.github.io/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/yingyingmonstre.github.io/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Boofuzz源码分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-03-22T02:00:00.000Z" title="发表于 2022-03-22 10:00:00">2022-03-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-09T08:40:03.187Z" title="更新于 2022-08-09 16:40:03">2022-08-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/yingyingmonstre.github.io/categories/Fuzzing/">Fuzzing</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>52分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="Boofuzz样例"><a href="#Boofuzz样例" class="headerlink" title="Boofuzz样例"></a>Boofuzz样例</h3><p>以一个TFTP Fuzzer为例，大概看一下Boofuzz的用法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> boofuzz <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    session = Session(sleep_time=<span class="number">1</span>,</span><br><span class="line">                      target=Target(connection=SocketConnection(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">69</span>,proto=<span class="string">&quot;udp&quot;</span>)))</span><br><span class="line">    s_initialize(<span class="string">&quot;write&quot;</span>)</span><br><span class="line">    s_static(<span class="string">&quot;\\x00\\x02&quot;</span>)</span><br><span class="line">    s_string(<span class="string">&quot;filename&quot;</span>)</span><br><span class="line">    s_static(<span class="string">&quot;\\x00&quot;</span>)</span><br><span class="line">    s_static(<span class="string">&quot;netascii&quot;</span>)</span><br><span class="line">    s_static(<span class="string">&quot;\\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">    session.connect(s_get(<span class="string">&#x27;write&#x27;</span>))</span><br><span class="line">    session.fuzz()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>在源码中可以看到<code>SocketConnection</code>会在未来版本中移除，现在应该使用<code>BaseSocketConnection</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">warnings.warn(</span><br><span class="line">        <span class="string">&quot;SocketConnection is deprecated and will be removed in a future version of Boofuzz. &quot;</span></span><br><span class="line">        <span class="string">&quot;Use the classes derived from BaseSocketConnection instead.&quot;</span>,</span><br><span class="line">        FutureWarning,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>Fuzzer的创建包含三层，Session -&gt; Target -&gt; Connection</p>
<h3 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h3><p>顾名思义，Connection对象是网络连接的代表，Boofuzz支持各种基于socket的连接，从源码部分就可以看到，常用的还是TCP和UDP，这里还支持网络协议栈中2层和3层的原生Socket。</p>
<img src="/yingyingmonstre.github.io/2022/03/22/Boofuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/connection.png" class="">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">SocketConnection</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    host,</span></span></span><br><span class="line"><span class="function"><span class="params">    port=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    proto=<span class="string">&quot;tcp&quot;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    bind=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    send_timeout=<span class="number">5.0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    recv_timeout=<span class="number">5.0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    ethernet_proto=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    l2_dst=<span class="string">b&quot;\xFF&quot;</span> * <span class="number">6</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    udp_broadcast=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    server=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    sslcontext=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    server_hostname=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    warnings.warn(</span><br><span class="line">        <span class="string">&quot;SocketConnection is deprecated and will be removed in a future version of Boofuzz. &quot;</span></span><br><span class="line">        <span class="string">&quot;Use the classes derived from BaseSocketConnection instead.&quot;</span>,</span><br><span class="line">        FutureWarning,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> proto <span class="keyword">not</span> <span class="keyword">in</span> _PROTOCOLS:</span><br><span class="line">        <span class="keyword">raise</span> exception.SullyRuntimeError(<span class="string">&quot;INVALID PROTOCOL SPECIFIED: %s&quot;</span> % proto)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> proto <span class="keyword">in</span> _PROTOCOLS_PORT_REQUIRED <span class="keyword">and</span> port <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;__init__() argument port required for protocol &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(proto))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> proto == <span class="string">&quot;udp&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> udp_socket_connection.UDPSocketConnection(</span><br><span class="line">            host, port, send_timeout, recv_timeout, server, bind, udp_broadcast</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">elif</span> proto == <span class="string">&quot;tcp&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> tcp_socket_connection.TCPSocketConnection(host, port, send_timeout, recv_timeout, server)</span><br><span class="line">    <span class="keyword">elif</span> proto == <span class="string">&quot;ssl&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> ssl_socket_connection.SSLSocketConnection(</span><br><span class="line">            host, port, send_timeout, recv_timeout, server, sslcontext, server_hostname</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">elif</span> proto == <span class="string">&quot;raw-l2&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> raw_l2_socket_connection.RawL2SocketConnection(host, send_timeout, recv_timeout)</span><br><span class="line">    <span class="keyword">elif</span> proto == <span class="string">&quot;raw-l3&quot;</span>:</span><br><span class="line">        <span class="keyword">if</span> ethernet_proto <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            ethernet_proto = raw_l3_socket_connection.ETH_P_IP</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> raw_l3_socket_connection.RawL3SocketConnection(host, send_timeout, recv_timeout, ethernet_proto, l2_dst)</span><br></pre></td></tr></table></figure>

<p>在<code>SocketConnection</code>函数中根据我们传入的proto参数来调用响应Connection类的构造函数。</p>
<p>以<code>TCPSocketConnection</code>为例,其继承自<code>BaseSocketConnection</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TCPSocketConnection</span>(<span class="params">base_socket_connection.BaseSocketConnection</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;BaseSocketConnection implementation for use with TCP Sockets.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionadded:: 0.2.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        host (str): Hostname or IP adress of target system.</span></span><br><span class="line"><span class="string">        port (int): Port of target service.</span></span><br><span class="line"><span class="string">        send_timeout (float): Seconds to wait for send before timing out. Default 5.0.</span></span><br><span class="line"><span class="string">        recv_timeout (float): Seconds to wait for recv before timing out. Default 5.0.</span></span><br><span class="line"><span class="string">        server (bool): Set to True to enable server side fuzzing.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, host, port, send_timeout=<span class="number">5.0</span>, recv_timeout=<span class="number">5.0</span>, server=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(TCPSocketConnection, self).__init__(send_timeout, recv_timeout)</span><br><span class="line"></span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.server = server</span><br><span class="line">        self._serverSock = <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p><code>BaseSocketConnection</code>是一个继承了<code>itarget_connection.ITargetConnection</code>接口的抽象基类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseSocketConnection</span>(<span class="params">with_metaclass(<span class="params">abc.ABCMeta, itarget_connection.ITargetConnection</span>)</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;This class serves as a base for a number of Connections over sockets.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionadded:: 0.2.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        send_timeout (float): Seconds to wait for send before timing out. Default 5.0.</span></span><br><span class="line"><span class="string">        recv_timeout (float): Seconds to wait for recv before timing out. Default 5.0.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, send_timeout, recv_timeout</span>):</span></span><br><span class="line">        self._send_timeout = send_timeout</span><br><span class="line">        self._recv_timeout = recv_timeout</span><br><span class="line"></span><br><span class="line">        self._sock = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Close connection to the target.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self._sock.close()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Opens connection to the target. Make sure to call close!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self._sock.setsockopt(socket.SOL_SOCKET, socket.SO_SNDTIMEO, _seconds_to_sockopt_format(self._send_timeout))</span><br><span class="line">        self._sock.setsockopt(socket.SOL_SOCKET, socket.SO_RCVTIMEO, _seconds_to_sockopt_format(self._recv_timeout))</span><br></pre></td></tr></table></figure>



<h4 id="python元类编程"><a href="#python元类编程" class="headerlink" title="python元类编程"></a>python元类编程</h4><p>抽象类和接口都是面向对象里面的概念，抽象类是指一类<strong>不可直接实例化，只可被继承</strong>的类，接口则定义了继承接口的类必须实现的方法。python是没有这两个概念相关的关键字的，在python中，抽象类是以抽象基类的方式实现的(Abstract Base Classes, ABC)。</p>
<p>ABC中提供了<code>@abstractmethod</code>装饰器来指定抽象方法,下面代码中定义了一个抽象类C，并且定义了三个抽象方法，D类则是继承抽象类C然后实现了他的方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> abc</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>(<span class="params">metaclass=abc.ABCMeta</span>):</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">a</span>(<span class="params">self</span>):</span> <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clsa</span>(<span class="params">cls</span>):</span> <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stca</span>():</span> <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span>(<span class="params">C</span>):</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">a</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;property: a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clsa</span>(<span class="params">cls</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;classmethod clsa&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stca</span>():</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;staticmethod stca&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">d = D()</span><br><span class="line">d.a</span><br><span class="line"><span class="comment"># property: a</span></span><br><span class="line">d.clsa()</span><br><span class="line"><span class="comment"># classmethod clsa</span></span><br><span class="line">d.stca()</span><br><span class="line"><span class="comment"># staticmethod stca</span></span><br></pre></td></tr></table></figure>

<p>这里<code>BaseSocketConnection</code>的定义中用到了<code>with_metaclass</code>来创建这个类。</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/18513821/python-metaclass-understanding-the-with-metaclass">Python Metaclass : Understanding the ‘with_metaclass()’ - Stack Overflow</a></p>
<p>这里引入<code>with_metaclass</code>是为了兼容python2和python3，在我的python3.8上<code>with_metaclass</code>如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">with_metaclass</span>(<span class="params">meta, *bases</span>):</span></span><br><span class="line">		<span class="class"><span class="keyword">class</span> <span class="title">metaclass</span>(<span class="params">meta</span>):</span></span><br><span class="line">        __call__ = <span class="built_in">type</span>.__call__</span><br><span class="line">        __init__ = <span class="built_in">type</span>.__init__</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, name, this_bases, d</span>):</span></span><br><span class="line">            <span class="keyword">if</span> this_bases <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">type</span>.__new__(cls, name, (), d)</span><br><span class="line">            <span class="keyword">return</span> meta(name, bases, d)</span><br><span class="line">    <span class="keyword">return</span> metaclass(<span class="string">&#x27;temporary_class&#x27;</span>, <span class="literal">None</span>, &#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>根据<code>BaseSocketConnection</code>传入的参数，这里meta是<code>ABCmeta</code>，bases是<code>ITargetConnection</code>，这里是定义了一个临时元类metaclass继承自ABCmeta，并重写了其new方法，这样下面return时，就会依次调用其new和init方法来新建一个对象，而元类创建的是一个类，因此结果是一个基类为bases的抽象类，然后BaseSocketConnection就继承自它。这里具体的调试过程没搞明白。</p>
<p>总之这里BaseSocketConnection继承了ITargetConnection的接口，并且定义了一些基本方法，如open、send、recv、close以及关于延时的变量等。</p>
<h4 id="TCPSocketConnection"><a href="#TCPSocketConnection" class="headerlink" title="TCPSocketConnection"></a>TCPSocketConnection</h4><p>具体的TCPSocket的实现。</p>
<h5 id="open"><a href="#open" class="headerlink" title="open"></a>open</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open</span>(<span class="params">self</span>):</span></span><br><span class="line">    self._open_socket()</span><br><span class="line">    self._connect_socket()</span><br></pre></td></tr></table></figure>



<h5 id="open-socket函数"><a href="#open-socket函数" class="headerlink" title="open_socket函数"></a>open_socket函数</h5><p>就是创建一个socket。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_open_socket</span>(<span class="params">self</span>):</span></span><br><span class="line">    self._sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># call superclass to set timeout sockopt</span></span><br><span class="line">    <span class="built_in">super</span>(TCPSocketConnection, self).<span class="built_in">open</span>()</span><br></pre></td></tr></table></figure>



<h5 id="connect-socket函数"><a href="#connect-socket函数" class="headerlink" title="connect_socket函数"></a>connect_socket函数</h5><p>这里可以看到boofuzz支持server被连接的模式，server只会接受一个连接。如果是多连接的场景，需要自己修改对应逻辑，主动连接同理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_connect_socket</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="comment">#server模式</span></span><br><span class="line">    <span class="keyword">if</span> self.server:</span><br><span class="line">        self._sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._sock.bind((self.host, self.port))</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> e.errno == errno.EADDRINUSE:</span><br><span class="line">                <span class="keyword">raise</span> exception.BoofuzzOutOfAvailableSockets()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        self._serverSock = self._sock</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment">#只会接受一个连接</span></span><br><span class="line">            self._serverSock.listen(<span class="number">1</span>)</span><br><span class="line">            self._sock, addr = self._serverSock.accept()</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># When connection timeout expires, tear down the server socket so we can re-open it again after</span></span><br><span class="line">            <span class="comment"># restarting the target.</span></span><br><span class="line">            self.close()</span><br><span class="line">            <span class="keyword">if</span> e.errno <span class="keyword">in</span> [errno.EAGAIN]:</span><br><span class="line">                <span class="keyword">raise</span> exception.BoofuzzTargetConnectionFailedError(<span class="built_in">str</span>(e))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">    <span class="comment">#主动连接</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._sock.connect((self.host, self.port))</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> e.errno == errno.EADDRINUSE:</span><br><span class="line">                <span class="keyword">raise</span> exception.BoofuzzOutOfAvailableSockets()</span><br><span class="line">            <span class="keyword">elif</span> e.errno <span class="keyword">in</span> [errno.ECONNREFUSED, errno.EINPROGRESS, errno.ETIMEDOUT]:</span><br><span class="line">                <span class="keyword">raise</span> exception.BoofuzzTargetConnectionFailedError(<span class="built_in">str</span>(e))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>



<h5 id="send"><a href="#send" class="headerlink" title="send"></a>send</h5><p>向目标发送数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        num_sent = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            num_sent = self._sock.send(data)</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> e.errno == errno.ECONNABORTED:</span><br><span class="line">                raise_(</span><br><span class="line">                    exception.BoofuzzTargetConnectionAborted(socket_errno=e.errno, socket_errmsg=e.strerror),</span><br><span class="line">                    <span class="literal">None</span>,</span><br><span class="line">                    sys.exc_info()[<span class="number">2</span>],</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">elif</span> e.errno <span class="keyword">in</span> [errno.ECONNRESET, errno.ENETRESET, errno.ETIMEDOUT, errno.EPIPE]:</span><br><span class="line">                raise_(exception.BoofuzzTargetConnectionReset(), <span class="literal">None</span>, sys.exc_info()[<span class="number">2</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> num_sent</span><br></pre></td></tr></table></figure>



<h5 id="recv"><a href="#recv" class="headerlink" title="recv"></a>recv</h5><p>这里可以设定最大接受字节数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv</span>(<span class="params">self, max_bytes</span>):</span></span><br><span class="line">        data = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = self._sock.recv(max_bytes)</span><br><span class="line">        <span class="keyword">except</span> socket.timeout:</span><br><span class="line">            data = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> e.errno == errno.ECONNABORTED:</span><br><span class="line">                raise_(</span><br><span class="line">                    exception.BoofuzzTargetConnectionAborted(socket_errno=e.errno, socket_errmsg=e.strerror),</span><br><span class="line">                    <span class="literal">None</span>,</span><br><span class="line">                    sys.exc_info()[<span class="number">2</span>],</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">elif</span> (e.errno == errno.ECONNRESET) <span class="keyword">or</span> (e.errno == errno.ENETRESET) <span class="keyword">or</span> (e.errno == errno.ETIMEDOUT):</span><br><span class="line">                raise_(exception.BoofuzzTargetConnectionReset(), <span class="literal">None</span>, sys.exc_info()[<span class="number">2</span>])</span><br><span class="line">            <span class="keyword">elif</span> e.errno == errno.EWOULDBLOCK:  <span class="comment"># timeout condition if using SO_RCVTIMEO or SO_SNDTIMEO</span></span><br><span class="line">                data = <span class="string">b&quot;&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>

<p>可以看出Connection这层就已经实现了连接的建立以及数据的收发相关的功能。</p>
<h3 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Target</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Target descriptor container.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Takes an ITargetConnection and wraps send/recv with appropriate</span></span><br><span class="line"><span class="string">    FuzzDataLogger calls.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>Target注释部分也说了，Target对象主要是在<code>Connection</code>的接口上wrap上log。可以看到Target的send函数，除了加的repeater功能，基本上就是添加了log。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Opens connection to the target. Make sure to call close!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self._fuzz_data_logger.log_info(<span class="string">&quot;Opening target connection (&#123;0&#125;)...&quot;</span>.<span class="built_in">format</span>(self._target_connection.info))</span><br><span class="line">    self._target_connection.<span class="built_in">open</span>()</span><br><span class="line">    self._fuzz_data_logger.log_info(<span class="string">&quot;Connection opened.&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">self, data</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Send data to the target. Only valid after calling open!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        data: Data to send.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    num_sent = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> self._fuzz_data_logger <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        repeat = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.repeater <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            repeat = <span class="string">&quot;, &quot;</span> + self.repeater.log_message()</span><br><span class="line"></span><br><span class="line">        self._fuzz_data_logger.log_info(<span class="string">&quot;Sending &#123;0&#125; bytes&#123;1&#125;...&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(data), repeat))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self.repeater <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        self.repeater.start()</span><br><span class="line">        <span class="keyword">while</span> self.repeater.repeat():</span><br><span class="line">            num_sent = self._target_connection.send(data=data)</span><br><span class="line">        self.repeater.reset()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        num_sent = self._target_connection.send(data=data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self._fuzz_data_logger <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        self._fuzz_data_logger.log_send(data[:num_sent])</span><br></pre></td></tr></table></figure>

<p>另外Target中还有一些Monitor的初始化工作，后面再说，Target中提供了设置Logger的接口函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_fuzz_data_logger</span>(<span class="params">self, fuzz_data_logger</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Set this object&#x27;s fuzz data logger -- for sent and received fuzz data.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param fuzz_data_logger: New logger.</span></span><br><span class="line"><span class="string">    :type fuzz_data_logger: ifuzz_logger.IFuzzLogger</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self._fuzz_data_logger = fuzz_data_logger</span><br></pre></td></tr></table></figure>

<p>在session中会调用这个函数来添加logger，默认是<code>FuzzLoggerText</code>。</p>
<h3 id="Session-Logger部分"><a href="#Session-Logger部分" class="headerlink" title="Session Logger部分"></a>Session Logger部分</h3><p>Session对象可以看成fuzzer的后端对象，其参数基本上就是涉及到fuzz控制的各种粒度，其函数基本上就是fuzz过程了。fuzz过程后面再分析，这里先看下上面余留的logger部分。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span>(<span class="params">pgraph.Graph</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">args</span>):</span></span><br><span class="line">        <span class="keyword">if</span> fuzz_loggers <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            fuzz_loggers = []</span><br><span class="line">            <span class="keyword">if</span> self.console_gui <span class="keyword">and</span> os.name != <span class="string">&quot;nt&quot;</span>:</span><br><span class="line">                fuzz_loggers.append(fuzz_logger_curses.FuzzLoggerCurses(web_port=self.web_port))</span><br><span class="line">                self._keep_web_open = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                fuzz_loggers = [fuzz_logger_text.FuzzLoggerText()]</span><br></pre></td></tr></table></figure>

<p>如果<code>fuzz_loggers</code>没指定的话，这里就设置成<code>FuzzLoggerText</code>，而<code>FuzzLoggerText</code>默认会设置为标注输出，因此就形成了打印到终端，所以如果想输出到文件，就可以set自己new的FuzzLoggerText，并设置其file_handle为文件句柄。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FuzzLoggerText</span>(<span class="params">ifuzz_logger_backend.IFuzzLoggerBackend</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, file_handle=sys.stdout, bytes_to_str=DEFAULT_HEX_TO_STR</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :type file_handle: io.BinaryIO</span></span><br><span class="line"><span class="string">        :param file_handle: Open file handle for logging. Defaults to sys.stdout.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :type bytes_to_str: function</span></span><br><span class="line"><span class="string">        :param bytes_to_str: Function that converts sent/received bytes data to string for logging.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self._file_handle = file_handle</span><br><span class="line">        self._format_raw_bytes = bytes_to_str</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_print_log_msg</span>(<span class="params">self, msg_type, msg=<span class="literal">None</span>, data=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            helpers.format_log_msg(msg_type=msg_type, description=msg, data=data, indent_size=self.INDENT_SIZE),</span><br><span class="line">            file=self._file_handle,</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>



<h3 id="数据格式"><a href="#数据格式" class="headerlink" title="数据格式"></a>数据格式</h3><p>boofuzz是基于格式的，因此在开始fuzz前需要先定义目标数据格式。boofuzz有两种数据定义的方式：Static Protocol Definition(old) 和 Protocol Definition(new) 。这两种数据定义的方式只是接口不同，其内部存储的格式是类似的，而且每种基本都够用了，所以这里只分析下Static Protocol Definition。</p>
<p><a target="_blank" rel="noopener" href="https://boofuzz.readthedocs.io/en/stable/user/static-protocol-definition.html">Static Protocol Definition — boofuzz 0.4.0 documentation</a></p>
<p><a target="_blank" rel="noopener" href="https://boofuzz.readthedocs.io/en/stable/user/protocol-definition.html">Protocol Definition — boofuzz 0.4.0 documentation</a></p>
<p>数据分成三个层次，Requests是发出的message，Blocks来组成message，Primitives(原语)是组成block的元素(字节、字符串、数字、校验和等)。</p>
<h4 id="s-initialize"><a href="#s-initialize" class="headerlink" title="s_initialize"></a>s_initialize</h4><p><code>s_initialize</code>会创建一个request，我们需要提供一个name来标识这个request，新建的request会被加到<code>REQUESTS</code>中，并设置为当前操作的Request。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">s_initialize</span>(<span class="params">name</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Initialize a new block request. All blocks / primitives generated after this call apply to the named request.</span></span><br><span class="line"><span class="string">    Use s_switch() to jump between factories.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :type  name: str</span></span><br><span class="line"><span class="string">    :param name: Name of request</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">in</span> blocks.REQUESTS:</span><br><span class="line">        <span class="keyword">raise</span> exception.SullyRuntimeError(<span class="string">&quot;blocks.REQUESTS ALREADY EXISTS: %s&quot;</span> % name)</span><br><span class="line">		<span class="comment">#REQUESTS是全局字典，这里向其添加个request</span></span><br><span class="line">    blocks.REQUESTS[name] = Request(name)</span><br><span class="line">    <span class="comment">#同时将新建的设置为当前操作的request</span></span><br><span class="line">    blocks.CURRENT = blocks.REQUESTS[name]</span><br></pre></td></tr></table></figure>



<h4 id="Session-init"><a href="#Session-init" class="headerlink" title="Session.init"></a>Session.init</h4><p>Session中创建根结点，用户可以指定一些initial requests：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对图初始化，新建一个root节点</span></span><br><span class="line"> self.root = pgraph.Node()</span><br><span class="line"> self.root.label = <span class="string">&quot;__ROOT_NODE__&quot;</span></span><br><span class="line"> self.root.name = self.root.label</span><br><span class="line"> self.last_recv = <span class="literal">None</span></span><br><span class="line"> self.last_send = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"> self.add_node(self.root)</span><br><span class="line">  <span class="comment">#把传进来的target加到target数组中</span></span><br><span class="line"> <span class="keyword">if</span> target <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">apply_options</span>(<span class="params">monitor</span>):</span></span><br><span class="line">         monitor.set_options(crash_filename=self._crash_filename)</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">     target.monitor_alive.append(apply_options)</span><br><span class="line"></span><br><span class="line">     <span class="keyword">try</span>:</span><br><span class="line">         self.add_target(target)</span><br><span class="line">     <span class="keyword">except</span> exception.BoofuzzRpcError <span class="keyword">as</span> e:</span><br><span class="line">         self._fuzz_data_logger.log_error(<span class="built_in">str</span>(e))</span><br><span class="line">         <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>



<h4 id="s-get、s-switch"><a href="#s-get、s-switch" class="headerlink" title="s_get、s_switch"></a>s_get、s_switch</h4><p>网络协议一般是各种Request的状态转移图，Boofuzz也支持建立这种图。我们可以再次调用s_initialize来创建一个新的Request，通过s_get可以在不同的Request直接切换，从而改变当前操作的对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">s_get</span>(<span class="params">name=<span class="literal">None</span></span>):</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> name:</span><br><span class="line">        <span class="keyword">return</span> blocks.CURRENT</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ensure this gotten request is the new current.</span></span><br><span class="line">    s_switch(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> blocks.REQUESTS:</span><br><span class="line">        <span class="keyword">raise</span> exception.SullyRuntimeError(<span class="string">&quot;blocks.REQUESTS NOT FOUND: %s&quot;</span> % name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> blocks.REQUESTS[name]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">s_switch</span>(<span class="params">name</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Change the current request to the one specified by &quot;name&quot;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :type  name: str</span></span><br><span class="line"><span class="string">    :param name: Name of request</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> blocks.REQUESTS:</span><br><span class="line">        <span class="keyword">raise</span> exception.SullyRuntimeError(<span class="string">&quot;blocks.REQUESTS NOT FOUND: %s&quot;</span> % name)</span><br><span class="line">		<span class="comment">#将name的Request设置为CURRENT</span></span><br><span class="line">    blocks.CURRENT = blocks.REQUESTS[name]</span><br></pre></td></tr></table></figure>



<h4 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h4><p>connect是连边，即在两个Node(Request)上连边。只填一个参数的话，就是默认把提供的参数node连到root上，node就是Request对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self, src, dst=<span class="literal">None</span>, callback=<span class="literal">None</span></span>):</span></span><br><span class="line"><span class="comment"># if only a source was provided, then make it the destination and set the source to the root node.</span></span><br><span class="line">        <span class="keyword">if</span> dst <span class="keyword">is</span> <span class="literal">None</span>:  <span class="comment">#dst不指定就是从 root连接到src</span></span><br><span class="line">            dst = src</span><br><span class="line">            src = self.root</span><br><span class="line"></span><br><span class="line">        <span class="comment"># if source or destination is a name, resolve the actual node.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(src, six.string_types):</span><br><span class="line">            src = self.find_node(<span class="string">&quot;name&quot;</span>, src)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(dst, six.string_types):</span><br><span class="line">            dst = self.find_node(<span class="string">&quot;name&quot;</span>, dst)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># if source or destination is not in the graph, add it.</span></span><br><span class="line">        <span class="keyword">if</span> src != self.root <span class="keyword">and</span> self.find_node(<span class="string">&quot;name&quot;</span>, src.name) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.add_node(src)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.find_node(<span class="string">&quot;name&quot;</span>, dst.name) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.add_node(dst)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create an edge between the two nodes and add it to the graph.</span></span><br><span class="line">        edge = Connection(src.<span class="built_in">id</span>, dst.<span class="built_in">id</span>, callback)  <span class="comment">#建边</span></span><br><span class="line">        self.add_edge(edge)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> edge</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_node</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Add a pgraph node to the graph. We overload this routine to automatically generate and assign an ID whenever a</span></span><br><span class="line"><span class="string">        node is added.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            node (pgraph.Node): Node to add to session graph</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        node.number = <span class="built_in">len</span>(self.nodes)</span><br><span class="line">        node.<span class="built_in">id</span> = <span class="built_in">len</span>(self.nodes)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> node.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> self.nodes:</span><br><span class="line">            self.nodes[node.<span class="built_in">id</span>] = node</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self</span><br></pre></td></tr></table></figure>

<p>这个 Connection 就是继承自最朴素的Edge(边)，只不过其提供了一个callback参数，这个会在状态转移的时候调用，因此可以添加一些自定义的功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span>(<span class="params">pgraph.Edge</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, src, dst, callback=<span class="literal">None</span></span>):</span></span><br><span class="line">		    <span class="built_in">super</span>(Connection, self).__init__(src, dst)</span><br><span class="line"></span><br><span class="line">        self.callback = callback</span><br></pre></td></tr></table></figure>

<p>状态图案例：</p>
<img src="/yingyingmonstre.github.io/2022/03/22/Boofuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/connect_graph.png" class="">

<p>创建完Request之后，接下来就是向里面添加Primitives，根据数据类型划分出多个添加函数，首先看string类型的函数s_string。</p>
<h4 id="s-string"><a href="#s-string" class="headerlink" title="s_string"></a>s_string</h4><p>函数中新建String对象后，通过Request的push函数填充到request中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">s_string</span>(<span class="params">value=<span class="string">&quot;&quot;</span>, size=<span class="literal">None</span>, padding=<span class="string">b&quot;\x00&quot;</span>, encoding=<span class="string">&quot;ascii&quot;</span>, fuzzable=<span class="literal">True</span>, max_len=<span class="literal">None</span>, name=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="comment"># support old interface where default was -1 instead of None</span></span><br><span class="line">    <span class="keyword">if</span> size == -<span class="number">1</span>:</span><br><span class="line">        size = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> max_len == -<span class="number">1</span>:</span><br><span class="line">        max_len = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    blocks.CURRENT.push(</span><br><span class="line">        String(</span><br><span class="line">            name=name,</span><br><span class="line">            default_value=value,</span><br><span class="line">            size=size,</span><br><span class="line">            padding=padding,</span><br><span class="line">            encoding=encoding,</span><br><span class="line">            max_len=max_len,</span><br><span class="line">            fuzzable=fuzzable,</span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>



<h4 id="Request-push"><a href="#Request-push" class="headerlink" title="Request.push"></a>Request.push</h4><p>1.首先给传进来的item也就是Primitive添加一些环境信息：</p>
<p> (1)context_path: 调用<code>_generate_context_path</code>产生的字符串，<code>_generate_context_path</code>是将<code>block_stack</code>中的字符串全部拼接在一起产生路径字符串，用于标记item的位置；</p>
<p> (2)设置item的request为当前request。</p>
<p>2.检查item的<code>qualified_name</code>是否重复，判断是否将item加入到names map中；</p>
<p>3.如果当前request还没有block，<code>block_stack</code>就为空，就将item插入到request的stack中；如果<code>block_stack</code>不为空，就相当于现在还在组建block，就把item插入到栈顶的block中；</p>
<p>4.如果item是block，会先把block插入到stack中，然后插入到<code>block_stack</code>中作为当前的<code>open_block</code>,接下来的primitive都会插入到该block里面。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push</span>(<span class="params">self, item</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Push an item into the block structure. If no block is open, the item goes onto the request stack. otherwise,</span></span><br><span class="line"><span class="string">    the item goes onto the last open blocks stack.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    What this method does:</span></span><br><span class="line"><span class="string">    1. Sets context_path for each pushed FuzzableWrapper.</span></span><br><span class="line"><span class="string">    2. Sets request for each FuzzableWrapper</span></span><br><span class="line"><span class="string">    3. Checks for duplicate qualified_name items</span></span><br><span class="line"><span class="string">    4. Adds item to self.names map (based on qualified_name)</span></span><br><span class="line"><span class="string">    5. Adds the item to self.stack, or to the stack of the currently opened block.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Also: Manages block_stack, mostly an implementation detail to help static protocol definition</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @type item: BasePrimitive | Block | Request | Size | Repeat</span></span><br><span class="line"><span class="string">    @param item: Some primitive/block/request/etc.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    item.context_path = self._generate_context_path(self.block_stack)</span><br><span class="line">    item.request = self</span><br><span class="line">    <span class="comment"># ensure the name doesn&#x27;t already exist.</span></span><br><span class="line">    <span class="keyword">if</span> item.qualified_name <span class="keyword">in</span> <span class="built_in">list</span>(self.names):</span><br><span class="line">        <span class="keyword">raise</span> exception.SullyRuntimeError(<span class="string">&quot;BLOCK NAME ALREADY EXISTS: %s&quot;</span> % item.qualified_name)</span><br><span class="line"></span><br><span class="line">    self.names[item.qualified_name] = item</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if there are no open blocks, the item gets pushed onto the request stack.</span></span><br><span class="line">    <span class="comment"># otherwise, the pushed item goes onto the stack of the last opened block.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.block_stack:</span><br><span class="line">        self.stack.append(item)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.block_stack[-<span class="number">1</span>].push(item)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add the opened block to the block stack.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, Block) <span class="keyword">or</span> <span class="built_in">isinstance</span>(item, Aligned):  <span class="comment"># TODO generic check here</span></span><br><span class="line">        self.block_stack.append(item)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_generate_context_path</span>(<span class="params">self, block_stack</span>):</span></span><br><span class="line">    context_path = <span class="string">&quot;.&quot;</span>.join(x.name <span class="keyword">for</span> x <span class="keyword">in</span> block_stack)  <span class="comment"># TODO put in method</span></span><br><span class="line">    context_path = <span class="string">&quot;.&quot;</span>.join(<span class="built_in">filter</span>(<span class="literal">None</span>, (self.name, context_path)))</span><br><span class="line">    <span class="keyword">return</span> context_path</span><br></pre></td></tr></table></figure>



<h4 id="block"><a href="#block" class="headerlink" title="block"></a>block</h4><p>根据doc，有两种插入block的方式：<code>startend</code>和<code>with</code>模式。</p>
<h5 id="startend方式"><a href="#startend方式" class="headerlink" title="startend方式"></a>startend方式</h5><p><code>s_block_start </code>初始化一个block，并将其push。</p>
<p><code>s_block_close </code>关闭这个block，说明数据已经填充完毕了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> s_block_start(<span class="string">&quot;header&quot;</span>):</span><br><span class="line">    s_static(<span class="string">&quot;\x00\x01&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> s_block_start(<span class="string">&quot;body&quot;</span>):</span><br><span class="line">        ...</span><br><span class="line">s_block_end()</span><br></pre></td></tr></table></figure>

<p><code>s_block_start</code>函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">s_block_start</span>(<span class="params">name=<span class="literal">None</span>, *args, **kwargs</span>):</span></span><br><span class="line">    block = Block(name=name, *args, **kwargs)</span><br><span class="line">    blocks.CURRENT.push(block)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> block</span><br></pre></td></tr></table></figure>

<p><code>s_block_end</code>函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">s_block_end</span>(<span class="params">name=<span class="literal">None</span></span>):</span></span><br><span class="line">    blocks.CURRENT.pop()</span><br></pre></td></tr></table></figure>



<h5 id="with方式"><a href="#with方式" class="headerlink" title="with方式"></a>with方式</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> s_block(<span class="string">&quot;header&quot;</span>):</span><br><span class="line">    s_static(<span class="string">&quot;\x00\x01&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> s_block_start(<span class="string">&quot;body&quot;</span>):</span><br></pre></td></tr></table></figure>

<p>with方式能用是因为<code>s_block</code>中调用的是<code>s_block_start</code>插入block，但是返回的是个<code>ScopedBlock</code>对象，这个对象注册了<strong>exit</strong>方法。</p>
<p>当with范围结束时，就会调用<code>s_block_end</code>方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">s_block</span>(<span class="params">name=<span class="literal">None</span>, group=<span class="literal">None</span>, encoder=<span class="literal">None</span>, dep=<span class="literal">None</span>, dep_value=<span class="literal">None</span>, dep_values=<span class="literal">None</span>, dep_compare=<span class="string">&quot;==&quot;</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ScopedBlock</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, block</span>):</span></span><br><span class="line">            self.block = block</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">            <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            Setup before entering the &quot;with&quot; statement body</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">return</span> self.block</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, <span class="built_in">type</span>, value, traceback</span>):</span></span><br><span class="line">            <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            Cleanup after executing the &quot;with&quot; statement body</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            <span class="comment"># Automagically close the block when exiting the &quot;with&quot; statement</span></span><br><span class="line">            s_block_end()</span><br><span class="line"></span><br><span class="line">    block = s_block_start(</span><br><span class="line">        name,</span><br><span class="line">        request=blocks.CURRENT,</span><br><span class="line">        group=group,</span><br><span class="line">        encoder=encoder,</span><br><span class="line">        dep=dep,</span><br><span class="line">        dep_value=dep_value,</span><br><span class="line">        dep_values=dep_values,</span><br><span class="line">        dep_compare=dep_compare,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ScopedBlock(block)</span><br></pre></td></tr></table></figure>



<h3 id="start-fuzz"><a href="#start-fuzz" class="headerlink" title="start fuzz"></a>start fuzz</h3><h4 id="fuzz"><a href="#fuzz" class="headerlink" title="fuzz"></a>fuzz</h4><p>fuzz开始于fuzz函数，传入一个request的name的话就只会fuzz这个request，不传就会按建立的图去遍历着fuzz。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fuzz</span>(<span class="params">self, name=<span class="literal">None</span>, max_depth=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Fuzz the entire protocol tree.</span></span><br><span class="line"><span class="string">    Iterates through and fuzzes all fuzz cases, skipping according to</span></span><br><span class="line"><span class="string">    self.skip and restarting based on self.restart_interval.</span></span><br><span class="line"><span class="string">    If you want the web server to be available, your program must persist</span></span><br><span class="line"><span class="string">    after calling this method. helpers.pause_for_signal() is</span></span><br><span class="line"><span class="string">    available to this end.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        name (str): Pass in a Request name to fuzz only a single request message. Pass in a test case name to fuzz only a single test case.</span></span><br><span class="line"><span class="string">        max_depth (int): Maximum combinatorial depth; set to 1 for &quot;simple&quot; fuzzing.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self.total_mutant_index = <span class="number">0</span></span><br><span class="line">    self.total_num_mutations = self.num_mutations(max_depth=max_depth)</span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> name == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        self._main_fuzz_loop(self._generate_mutations_indefinitely(max_depth=max_depth))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.fuzz_by_name(name=name)</span><br></pre></td></tr></table></figure>



<h4 id="main-fuzz-loop"><a href="#main-fuzz-loop" class="headerlink" title="_main_fuzz_loop"></a>_main_fuzz_loop</h4><p>1.首先会开启一个boofuzz的可视化web server；</p>
<p>2.调用<code>_start_target</code>启动target，一般测试服务器的时候，是我们手动启动目标服务器，所以用不到这个，但是配合<code>ProcMonitor</code>我们可以设置自启动目标(Windows平台)；</p>
<p>3.记录fuzz开始时间；</p>
<p>4.开始fuzz大循环，每次循环调用<code>_fuzz_current_case</code>进行fuzz；</p>
<p>5.<code>num_cases_actually_fuzzed+1</code>，如果<code>_index_end</code>参数不为空且<code>total_mutant_index</code>&gt;=<code>_index_end</code>的话就结束fuzz；</p>
<p>6.记录fuzz结束时间。</p>
<p>这里还有个选项是<code>_reuse_target_connection</code>，即重用连接。开启这个选项后，整个大循环中只会在这里open一次连接，如果不开这个选项，每次fuzz都会重新open一次连接。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_main_fuzz_loop</span>(<span class="params">self, fuzz_case_iterator</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Execute main fuzz logic; takes an iterator of test cases.</span></span><br><span class="line"><span class="string">    Preconditions: `self.total_mutant_index` and `self.total_num_mutations` are set properly.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        fuzz_case_iterator (Iterable): An iterator that walks through fuzz cases and yields MutationContext objec</span></span><br><span class="line"><span class="string">             See _iterate_single_node() for details.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment">#这里是创建线程开启一个boofuzz的可视化web端口</span></span><br><span class="line">    <span class="keyword">if</span> self.web_port <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        self.server_init()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    self._start_target(self.targets[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> self._reuse_target_connection:</span><br><span class="line">        self.targets[<span class="number">0</span>].<span class="built_in">open</span>()</span><br><span class="line">    self.num_cases_actually_fuzzed = <span class="number">0</span></span><br><span class="line">    <span class="comment">#记录fuzz开始时间</span></span><br><span class="line">    self.start_time = time.time()</span><br><span class="line">    <span class="keyword">for</span> mutation_context <span class="keyword">in</span> fuzz_case_iterator:</span><br><span class="line">        <span class="keyword">if</span> self.total_mutant_index &lt; self._index_start:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># Check restart interval</span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            self.num_cases_actually_fuzzed</span><br><span class="line">            <span class="keyword">and</span> self.restart_interval</span><br><span class="line">            <span class="keyword">and</span> self.num_cases_actually_fuzzed % self.restart_interval == <span class="number">0</span></span><br><span class="line">        ):</span><br><span class="line">            self._fuzz_data_logger.open_test_step(<span class="string">&quot;restart interval of %d reached&quot;</span> % self.restart_interval)</span><br><span class="line">            self._restart_target(self.targets[<span class="number">0</span>])</span><br><span class="line">        <span class="comment">#这里开始fuzz这次</span></span><br><span class="line">        self._fuzz_current_case(mutation_context)</span><br><span class="line">        <span class="comment">#这里是记录实际进行fuzz的次数</span></span><br><span class="line">        self.num_cases_actually_fuzzed += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> self._index_end <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.total_mutant_index &gt;= self._index_end:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> self._reuse_target_connection:</span><br><span class="line">        self.targets[<span class="number">0</span>].close()</span><br><span class="line">    <span class="keyword">if</span> self._keep_web_open <span class="keyword">and</span> self.web_port <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        self.end_time = time.time()</span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            <span class="string">&quot;\nFuzzing session completed. Keeping webinterface up on localhost:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.web_port),</span><br><span class="line">            <span class="string">&quot;\nPress ENTER to close webinterface&quot;</span>,</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">input</span>()</span><br></pre></td></tr></table></figure>



<h4 id="start-target"><a href="#start-target" class="headerlink" title="_start_target"></a>_start_target</h4><p>内部调用monitor的<code>start_target</code>来启动目标，目标启动后，调用monitor的<code>post_start_target</code>回调函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_start_target</span>(<span class="params">self, target</span>):</span></span><br><span class="line">    started = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> monitor <span class="keyword">in</span> target.monitors:</span><br><span class="line">        <span class="keyword">if</span> monitor.start_target():</span><br><span class="line">            started = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> started:</span><br><span class="line">        <span class="keyword">for</span> monitor <span class="keyword">in</span> target.monitors:</span><br><span class="line">            monitor.post_start_target(target=target, fuzz_data_logger=self._fuzz_data_logger, session=self)</span><br></pre></td></tr></table></figure>



<h4 id="fuzz-current-case"><a href="#fuzz-current-case" class="headerlink" title="_fuzz_current_case"></a>_fuzz_current_case</h4><p>1.打印一些信息；</p>
<p>2.调用<code>_open_connection_keep_trying</code>打开连接，在这里可以实现自定义的网络状态monitor；</p>
<p>3.调用<code>_pre_send</code>函数，这里会调用monitor中的<code>pre_send</code>回调函数（Session处填的<code>pre_send_callback</code>会复制到<code>CallbackMonitor</code>的<code>on_pre_send</code>中，这里pre_send就会调用它们）具体可以看后面单独对<code>CallbackMonitor</code>的分析；</p>
<p>4.调用edge的callback函数，产生callback数据；</p>
<p>5.调用<code>transmit_fuzz</code>进行测试数据的收发；</p>
<p>6.调用<code>_check_for_passively_detected_failures</code>函数检查是否发生了crash。</p>
<p>根据设置的<code>sleep_time</code>参数暂停。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_fuzz_current_case</span>(<span class="params">self, mutation_context</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Fuzzes the current test case. Current test case is controlled by</span></span><br><span class="line"><span class="string">    fuzz_case_iterator().</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        mutation_context (MutationContext): Current mutation context.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    target = self.targets[<span class="number">0</span>]</span><br><span class="line">    self._pause_if_pause_flag_is_set()</span><br><span class="line">    test_case_name = self._test_case_name(mutation_context)</span><br><span class="line">    self.current_test_case_name = test_case_name</span><br><span class="line">    self._fuzz_data_logger.open_test_case(</span><br><span class="line">        <span class="string">&quot;&#123;0&#125;: &#123;1&#125;&quot;</span>.<span class="built_in">format</span>(self.total_mutant_index, test_case_name),</span><br><span class="line">        name=test_case_name,</span><br><span class="line">        index=self.total_mutant_index,</span><br><span class="line">        num_mutations=self.total_num_mutations,</span><br><span class="line">        current_index=self.mutant_index,</span><br><span class="line">        current_num_mutations=self.fuzz_node.get_num_mutations(),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> self.total_num_mutations <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        self._fuzz_data_logger.log_info(</span><br><span class="line">            <span class="string">&quot;Type: &#123;0&#125;. Case &#123;1&#125; of &#123;2&#125; overall.&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                <span class="built_in">type</span>(self.fuzz_node.mutant).__name__,</span><br><span class="line">                self.total_mutant_index,</span><br><span class="line">                self.total_num_mutations,</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self._fuzz_data_logger.log_info(</span><br><span class="line">            <span class="string">&quot;Type: &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                <span class="built_in">type</span>(self.fuzz_node.mutant).__name__,</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment">#打开连接</span></span><br><span class="line">        self._open_connection_keep_trying(target)</span><br><span class="line">        <span class="comment">#_pre_send被调用</span></span><br><span class="line">        self._pre_send(target)</span><br><span class="line">    	  <span class="comment">#这里是正常发送message_path最后一条路径前面的路径数据，这里就可以看出boofuzz是按node进行fuzz的</span></span><br><span class="line">        <span class="keyword">for</span> e <span class="keyword">in</span> mutation_context.message_path[:-<span class="number">1</span>]:</span><br><span class="line">            prev_node = self.nodes[e.src]</span><br><span class="line">            node = self.nodes[e.dst]</span><br><span class="line">            protocol_session = ProtocolSession(</span><br><span class="line">                previous_message=prev_node,</span><br><span class="line">                current_message=node,</span><br><span class="line">            )</span><br><span class="line">            mutation_context.protocol_session = protocol_session</span><br><span class="line">            callback_data = self._callback_current_node(node=node, edge=e, test_case_context=protocol_session)</span><br><span class="line">            self._fuzz_data_logger.open_test_step(<span class="string">&quot;Transmit Prep Node &#x27;&#123;0&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(node.name))</span><br><span class="line">            self.transmit_normal(target, node, e, callback_data=callback_data, mutation_context=mutation_context)</span><br><span class="line">        prev_node = self.nodes[mutation_context.message_path[-<span class="number">1</span>].src]</span><br><span class="line">        node = self.nodes[mutation_context.message_path[-<span class="number">1</span>].dst]</span><br><span class="line">        protocol_session = ProtocolSession(</span><br><span class="line">            previous_message=prev_node,</span><br><span class="line">            current_message=node,</span><br><span class="line">        )</span><br><span class="line">        mutation_context.protocol_session = protocol_session</span><br><span class="line">        <span class="comment">#这里会调用callback，同时返回一个callback数据</span></span><br><span class="line">        callback_data = self._callback_current_node(</span><br><span class="line">            node=self.fuzz_node, edge=mutation_context.message_path[-<span class="number">1</span>], test_case_context=protocol_session</span><br><span class="line">        )</span><br><span class="line">        self._fuzz_data_logger.open_test_step(<span class="string">&quot;Fuzzing Node &#x27;&#123;0&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(self.fuzz_node.name))</span><br><span class="line">        <span class="comment">#进行实际的数据发送</span></span><br><span class="line">        self.transmit_fuzz(</span><br><span class="line">            target,</span><br><span class="line">            self.fuzz_node,</span><br><span class="line">            mutation_context.message_path[-<span class="number">1</span>],</span><br><span class="line">            callback_data=callback_data,</span><br><span class="line">            mutation_context=mutation_context,</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">#检查是否发生了crash</span></span><br><span class="line">        self._check_for_passively_detected_failures(target=target)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._reuse_target_connection:</span><br><span class="line">            target.close()</span><br><span class="line">        <span class="comment">#这里也提供了接口来睡眠</span></span><br><span class="line">        <span class="keyword">if</span> self.sleep_time &gt; <span class="number">0</span>:</span><br><span class="line">            self._fuzz_data_logger.open_test_step(<span class="string">&quot;Sleep between tests.&quot;</span>)</span><br><span class="line">            self._sleep(self.sleep_time)</span><br></pre></td></tr></table></figure>



<h4 id="open-connection-keep-trying"><a href="#open-connection-keep-trying" class="headerlink" title="_open_connection_keep_trying"></a>_open_connection_keep_trying</h4><p>在不开启<code>_reuse_target_connection</code>的情况下调用target的open函数，代码中已经实现了自定义的网络状态monitor。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_open_connection_keep_trying</span>(<span class="params">self, target</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Open connection and if it fails, keep retrying.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        target (Target): Target to open.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment">#只有不开_reuse_target_connection的时候才会open</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self._reuse_target_connection:</span><br><span class="line">        out_of_available_sockets_count = <span class="number">0</span></span><br><span class="line">        unable_to_connect_count = <span class="number">0</span></span><br><span class="line">        initial_time = time.time()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment">#内部就是调用target的open函数，前面已经分析了</span></span><br><span class="line">                target.<span class="built_in">open</span>()</span><br><span class="line">                <span class="keyword">break</span>  <span class="comment"># break if no exception</span></span><br><span class="line">            <span class="keyword">except</span> exception.BoofuzzTargetConnectionFailedError:</span><br><span class="line">                <span class="keyword">if</span> self.restart_threshold <span class="keyword">and</span> unable_to_connect_count &gt;= self.restart_threshold:</span><br><span class="line">                    self._fuzz_data_logger.log_info(</span><br><span class="line">                        <span class="string">&quot;Unable to reconnect to target: Reached threshold of &#123;0&#125; retries. Ending fuzzing.&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                            self.restart_threshold</span><br><span class="line">                        )</span><br><span class="line">                    )</span><br><span class="line">                    <span class="comment">#自添加代码，实现网络状态的Monitor</span></span><br><span class="line">                    <span class="keyword">with</span> <span class="built_in">open</span>(self.crash_filename + <span class="string">&quot;_&quot;</span> + <span class="built_in">str</span>(self.num_cases_actually_fuzzed),<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">                        fp.write((self.current_test_case_name+<span class="string">&quot;\n&quot;</span>).encode())</span><br><span class="line">                        fp.write(self.last_send)</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">                    <span class="keyword">raise</span></span><br><span class="line">                <span class="keyword">elif</span> self.restart_timeout <span class="keyword">and</span> time.time() &gt;= initial_time + self.restart_timeout:</span><br><span class="line">                    self._fuzz_data_logger.log_info(</span><br><span class="line">                        <span class="string">&quot;Unable to reconnect to target: Reached restart timeout of &#123;0&#125;s. Ending fuzzing.&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                            self.restart_timeout</span><br><span class="line">                        )</span><br><span class="line">                    )</span><br><span class="line">                    <span class="keyword">raise</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self._fuzz_data_logger.log_info(constants.WARN_CONN_FAILED_TERMINAL)</span><br><span class="line">                    self._restart_target(target)</span><br><span class="line">                    unable_to_connect_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">except</span> exception.BoofuzzOutOfAvailableSockets:</span><br><span class="line">                out_of_available_sockets_count += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> out_of_available_sockets_count == <span class="number">50</span>:</span><br><span class="line">                    <span class="keyword">raise</span> exception.BoofuzzError(<span class="string">&quot;There are no available sockets. Ending fuzzing.&quot;</span>)</span><br><span class="line">                self._fuzz_data_logger.log_info(<span class="string">&quot;There are no available sockets. Waiting for another 5 seconds.&quot;</span>)</span><br><span class="line">                time.sleep(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>



<h4 id="pre-send"><a href="#pre-send" class="headerlink" title="_pre_send"></a>_pre_send</h4><p>依次调用target的monitor中的回调函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_pre_send</span>(<span class="params">self, target</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Execute custom methods to run prior to each fuzz request. The order of events is as follows::</span></span><br><span class="line"><span class="string">        pre_send() - req - callback ... req - callback - post_send()</span></span><br><span class="line"><span class="string">    When fuzzing RPC for example, register this method to establish the RPC bind.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        target (session.target): Target we are sending data to</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> monitor <span class="keyword">in</span> target.monitors:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._fuzz_data_logger.open_test_step(<span class="string">&quot;Monitor &#123;&#125;.pre_send()&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(monitor)))</span><br><span class="line">            monitor.pre_send(target=target, fuzz_data_logger=self._fuzz_data_logger, session=self)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            self._fuzz_data_logger.log_error(</span><br><span class="line">                constants.ERR_CALLBACK_FUNC.<span class="built_in">format</span>(func_name=<span class="string">&quot;&#123;&#125;.pre_send()&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(monitor)))</span><br><span class="line">                + traceback.format_exc()</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>



<h4 id="callback-current-node"><a href="#callback-current-node" class="headerlink" title="_callback_current_node"></a>_callback_current_node</h4><p>调用当前边edge的callback函数，并返回callback数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_callback_current_node</span>(<span class="params">self, node, edge, test_case_context</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Execute callback preceding current node.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        test_case_context (ProtocolSession): Context for test case-scoped data.</span></span><br><span class="line"><span class="string">        node (pgraph.node.node (Node), optional): Current Request/Node</span></span><br><span class="line"><span class="string">        edge (pgraph.edge.edge (pgraph.edge), optional): Edge along the current fuzz path from &quot;node&quot; to next node.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        bytes: Data rendered by current node if any; otherwise None.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    data = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># if the edge has a callback, process it. the callback has the option to render the node, modify it and return.</span></span><br><span class="line">    <span class="comment">#调用edge的callback函数，并返回callback数据</span></span><br><span class="line">    <span class="keyword">if</span> edge.callback:</span><br><span class="line">        self._fuzz_data_logger.open_test_step(<span class="string">&quot;Callback function &#x27;&#123;0&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(edge.callback.__name__))</span><br><span class="line">        data = edge.callback(</span><br><span class="line">            self.targets[<span class="number">0</span>],</span><br><span class="line">            self._fuzz_data_logger,</span><br><span class="line">            session=self,</span><br><span class="line">            node=node,</span><br><span class="line">            edge=edge,</span><br><span class="line">            test_case_context=test_case_context,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>



<h4 id="check-for-passively-detected-failures"><a href="#check-for-passively-detected-failures" class="headerlink" title="_check_for_passively_detected_failures"></a>_check_for_passively_detected_failures</h4><p>依次调用monitor的<code>post_send</code>函数来获取是否发生了crash，如果发生了crash就继续调用<code>get_crash_synopsis</code>函数来获取crash概要。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_check_for_passively_detected_failures</span>(<span class="params">self, target, failure_already_detected=<span class="literal">False</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Check for and log passively detected failures. Return True if any found.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        target (Target): Target to be checked for failures.</span></span><br><span class="line"><span class="string">        failure_already_detected (bool): If a failure was already detected.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        bool: True if failures were found. False otherwise.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    has_crashed = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(target.monitors) &gt; <span class="number">0</span>:</span><br><span class="line">        self._fuzz_data_logger.open_test_step(<span class="string">&quot;Contact target monitors&quot;</span>)</span><br><span class="line">        <span class="comment"># So, we need to run through the array two times. First, we check</span></span><br><span class="line">        <span class="comment"># if any of the monitors reported a failure and</span></span><br><span class="line">        <span class="comment"># if so, we need to</span></span><br><span class="line">        <span class="comment"># gather a crash synopsis from them. We don&#x27;t know whether</span></span><br><span class="line">        <span class="comment"># a monitor can provide a crash synopsis, but in any case, we&#x27;ll</span></span><br><span class="line">        <span class="comment"># check. In the second run, we try to get crash synopsis from the</span></span><br><span class="line">        <span class="comment"># monitors that did not detect a crash as supplemental information.</span></span><br><span class="line">        finished_monitors = []</span><br><span class="line">        <span class="comment">#依次调用monitor的post_send函数</span></span><br><span class="line">        <span class="keyword">for</span> monitor <span class="keyword">in</span> target.monitors:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> monitor.post_send(target=target, fuzz_data_logger=self._fuzz_data_logger, session=self):</span><br><span class="line">                has_crashed = <span class="literal">True</span></span><br><span class="line">                self._fuzz_data_logger.log_fail(</span><br><span class="line">                    <span class="string">&quot;&#123;0&#125; detected crash on test case #&#123;1&#125;: &#123;2&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                        <span class="built_in">str</span>(monitor), self.total_mutant_index, monitor.get_crash_synopsis()</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">                finished_monitors.append(monitor)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> has_crashed <span class="keyword">and</span> <span class="keyword">not</span> failure_already_detected:</span><br><span class="line">            self._fuzz_data_logger.log_pass(<span class="string">&quot;No crash detected.&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">for</span> monitor <span class="keyword">in</span> <span class="built_in">set</span>(target.monitors) - <span class="built_in">set</span>(finished_monitors):</span><br><span class="line"></span><br><span class="line">                synopsis = monitor.get_crash_synopsis()</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(synopsis) &gt; <span class="number">0</span>:</span><br><span class="line">                    self._fuzz_data_logger.log_fail(</span><br><span class="line">                        <span class="string">&quot;&#123;0&#125; provided additional information for crash on #&#123;1&#125;: &#123;2&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                            <span class="built_in">str</span>(monitor), self.total_mutant_index, monitor.get_crash_synopsis()</span><br><span class="line">                        )</span><br><span class="line">                    )</span><br><span class="line">    <span class="keyword">return</span> has_crashed</span><br></pre></td></tr></table></figure>



<h4 id="transmit-fuzz"><a href="#transmit-fuzz" class="headerlink" title="transmit_fuzz"></a>transmit_fuzz</h4><p>进行实际的数据收发：</p>
<p>1.判断是否传入了callback数据，如果有callback数据就使用callback数据，否则调用render来产生变异数据；</p>
<p>2.发送数据，并将发送的数据保存在<code>last_send</code>中；</p>
<p>3.接受数据，并将接受的数据保存在<code>last_recv</code>中。</p>
<p><code>last_send</code>和<code>last_recv</code>都非常重要，<code>last_send</code>可以在监测crash时dump出来作为crash样本，<code>last_recv</code>则可以在边回调中决定状态机的走向，以及产生callback数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transmit_fuzz</span>(<span class="params">self, sock, node, edge, callback_data, mutation_context</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Render and transmit a fuzzed node, process callbacks accordingly.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        sock (Target, optional): Socket-like object on which to transmit node</span></span><br><span class="line"><span class="string">        node (pgraph.node.node (Node), optional): Request/Node to transmit</span></span><br><span class="line"><span class="string">        edge (pgraph.edge.edge (pgraph.edge), optional): Edge along the current fuzz path from &quot;node&quot; to next node.</span></span><br><span class="line"><span class="string">        callback_data (bytes): Data from previous callback.</span></span><br><span class="line"><span class="string">        mutation_context (MutationContext): Current mutation context.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment">#这里就可以看到，边的callback是先于数据发送的，如果callback返回了自定义数据，那这里就会直接拿callback返回的数据发送</span></span><br><span class="line">    <span class="comment">#如果callback返回空数据，这里就会正常调用变异的数据渲染，然后发送变异数据</span></span><br><span class="line">    <span class="keyword">if</span> callback_data:</span><br><span class="line">        data = callback_data</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data = self.fuzz_node.render(mutation_context)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:  <span class="comment"># send</span></span><br><span class="line">        <span class="comment">#这里发送变异数据，同时将发送的数据保存在last_send里面</span></span><br><span class="line">        self.targets[<span class="number">0</span>].send(data)</span><br><span class="line">        self.last_send = data</span><br><span class="line">    <span class="keyword">except</span> exception.BoofuzzTargetConnectionReset:</span><br><span class="line">        <span class="keyword">if</span> self._ignore_connection_issues_when_sending_fuzz_data:</span><br><span class="line">            self._fuzz_data_logger.log_info(constants.ERR_CONN_RESET)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> BoofuzzFailure(message=constants.ERR_CONN_RESET)</span><br><span class="line">    <span class="keyword">except</span> exception.BoofuzzTargetConnectionAborted <span class="keyword">as</span> e:</span><br><span class="line">        msg = constants.ERR_CONN_ABORTED.<span class="built_in">format</span>(socket_errno=e.socket_errno, socket_errmsg=e.socket_errmsg)</span><br><span class="line">        <span class="keyword">if</span> self._ignore_connection_issues_when_sending_fuzz_data:</span><br><span class="line">            self._fuzz_data_logger.log_info(msg)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> BoofuzzFailure(msg)</span><br><span class="line">    <span class="keyword">except</span> exception.BoofuzzSSLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">if</span> self._ignore_connection_ssl_errors:</span><br><span class="line">            self._fuzz_data_logger.log_info(<span class="built_in">str</span>(e))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> BoofuzzFailure(<span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">    received = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:  <span class="comment"># recv</span></span><br><span class="line">        <span class="keyword">if</span> self._receive_data_after_fuzz:</span><br><span class="line">            received = self.targets[<span class="number">0</span>].recv()</span><br><span class="line">    <span class="keyword">except</span> exception.BoofuzzTargetConnectionReset:</span><br><span class="line">        <span class="keyword">if</span> self._check_data_received_each_request:</span><br><span class="line">            <span class="keyword">raise</span> BoofuzzFailure(message=constants.ERR_CONN_RESET)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._fuzz_data_logger.log_info(constants.ERR_CONN_RESET)</span><br><span class="line">    <span class="keyword">except</span> exception.BoofuzzTargetConnectionAborted <span class="keyword">as</span> e:</span><br><span class="line">        msg = constants.ERR_CONN_ABORTED.<span class="built_in">format</span>(socket_errno=e.socket_errno, socket_errmsg=e.socket_errmsg)</span><br><span class="line">        <span class="keyword">if</span> self._check_data_received_each_request:</span><br><span class="line">            <span class="keyword">raise</span> BoofuzzFailure(msg)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._fuzz_data_logger.log_info(msg)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> exception.BoofuzzSSLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">if</span> self._ignore_connection_ssl_errors:</span><br><span class="line">            self._fuzz_data_logger.log_info(<span class="built_in">str</span>(e))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._fuzz_data_logger.log_fail(<span class="built_in">str</span>(e))</span><br><span class="line">            <span class="keyword">raise</span> BoofuzzFailure(<span class="built_in">str</span>(e))</span><br><span class="line">    <span class="comment">#这里会将这次接受到的数据保存在last_recv里面</span></span><br><span class="line">    self.last_recv = received</span><br></pre></td></tr></table></figure>



<h4 id="crash-dump"><a href="#crash-dump" class="headerlink" title="crash dump"></a>crash dump</h4><p>上面只介绍到监测crash而没说哪里dump crash，实际上crash的dump在各个Monitor中(在<code>_fuzz_current_case</code>函数中是没有的)。</p>
<p>以Procmon的<code>DebugThread</code>为例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post_send</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This routine is called after the fuzzer transmits a test case and returns the status of the target.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        bool: True if the target is still active, False otherwise.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> self.is_alive():</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(self.process_monitor.crash_filename, <span class="string">&quot;a&quot;</span>) <span class="keyword">as</span> rec_file:</span><br><span class="line">            rec_file.write(self.process_monitor.last_synopsis)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.process_monitor.coredump_dir <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            dest = os.path.join(self.process_monitor.coredump_dir, <span class="built_in">str</span>(self.process_monitor.test_number))</span><br><span class="line">            src = _get_coredump_path()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> src <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                self.log(<span class="string">&quot;moving core dump %s -&gt; %s&quot;</span> % (src, dest))</span><br><span class="line">                os.rename(src, dest)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>到此为止，数据的收发流程基本就了解了，剩下需要看下数据是怎么从request中产生并变异的。</p>
<h3 id="数据变异"><a href="#数据变异" class="headerlink" title="数据变异"></a>数据变异</h3><p><code>_generate_mutations_indefinitely</code>这里会产生一个iterator，迭代产生<code>mutation_context</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> name <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> name == <span class="string">&quot;&quot;</span>:</span><br><span class="line">    self._main_fuzz_loop(self._generate_mutations_indefinitely(max_depth=max_depth))</span><br></pre></td></tr></table></figure>



<h4 id="generate-mutations-indefinitely"><a href="#generate-mutations-indefinitely" class="headerlink" title="_generate_mutations_indefinitely"></a>_generate_mutations_indefinitely</h4><p>这里<code>max_path</code>默认传进来是个none。</p>
<p>调用<code>_generate_n_mutations</code>来产生<code>mutation_context</code>。</p>
<p>depth是在一次<code>fuzz_case</code>中，产生几个变异体：depth为1，那就是一次就变异一个primitive。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_generate_mutations_indefinitely</span>(<span class="params">self, max_depth=<span class="literal">None</span>, path=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Yield MutationContext with n mutations per message over all messages, with n increasing indefinitely.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># indefinitely 无限期的</span></span><br><span class="line">    depth = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> max_depth <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> depth &lt;= max_depth:</span><br><span class="line">        valid_case_found_at_this_depth = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self._generate_n_mutations(depth=depth, path=path):</span><br><span class="line">            valid_case_found_at_this_depth = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">yield</span> m</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> valid_case_found_at_this_depth:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        depth += <span class="number">1</span></span><br></pre></td></tr></table></figure>



<h4 id="generate-n-mutations"><a href="#generate-n-mutations" class="headerlink" title="_generate_n_mutations"></a>_generate_n_mutations</h4><p>这里会先得到path再从path里得到要fuzz的node。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_generate_n_mutations</span>(<span class="params">self, depth, path</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Yield MutationContext with n mutations per message over all messages.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment">#调试此处的yield</span></span><br><span class="line">    <span class="comment"># for path in self._iterate_protocol_message_paths(path=path):</span></span><br><span class="line">    <span class="comment">#     print(self._message_path_to_str(path))</span></span><br><span class="line">    <span class="comment">#先得到要fuzz的path，再从中获取要fuzz的node</span></span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> self._iterate_protocol_message_paths(path=path):</span><br><span class="line">        <span class="comment">#_generate_n_mutations_for_path这个函数会根据上面取得的path构建MutationContext</span></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self._generate_n_mutations_for_path(path, depth=depth):</span><br><span class="line">            <span class="keyword">yield</span> m</span><br></pre></td></tr></table></figure>



<h4 id="iterate-protocol-message-paths"><a href="#iterate-protocol-message-paths" class="headerlink" title="_iterate_protocol_message_paths"></a>_iterate_protocol_message_paths</h4><p>先检查下是否有target以及从root发出的边。</p>
<p>如果指定了path，就直接返回指定的path，但是默认为空。</p>
<p>调用<code>_iterate_protocol_message_paths_recursive</code>遍历path。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_iterate_protocol_message_paths</span>(<span class="params">self, path=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Iterates over protocol and yields a path (list of Connection) leading to a given message).</span></span><br><span class="line"><span class="string">    #如果指定了path的集合，就返回这个指定的边的集合，否则就遍历整个协议中所有的边的可能性</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        path (list of Connection): Provide a specific path to yield only that specific path.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Yields:</span></span><br><span class="line"><span class="string">        list of Connection: List of edges along the path to the current one being fuzzed.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        exception.SulleyRuntimeError: If no requests defined or no targets specified</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># we can&#x27;t fuzz if we don&#x27;t have at least one target and one request.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.targets:</span><br><span class="line">        <span class="keyword">raise</span> exception.SullyRuntimeError(<span class="string">&quot;No targets specified in session&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.edges_from(self.root.<span class="built_in">id</span>):</span><br><span class="line">        <span class="keyword">raise</span> exception.SullyRuntimeError(<span class="string">&quot;No requests specified in session&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> path <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">yield</span> path</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> self._iterate_protocol_message_paths_recursive(this_node=self.root, path=[]):</span><br><span class="line">            <span class="keyword">yield</span> x</span><br></pre></td></tr></table></figure>



<h4 id="iterate-protocol-message-paths-recursive"><a href="#iterate-protocol-message-paths-recursive" class="headerlink" title="_iterate_protocol_message_paths_recursive"></a>_iterate_protocol_message_paths_recursive</h4><p>这里遍历path的方法使用的是DFS，只不过用yield实现的，看着有些别扭，最终会产生从root出发的所有路径。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_iterate_protocol_message_paths_recursive</span>(<span class="params">self, this_node, path</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Recursive helper for _iterate_protocol.</span></span><br><span class="line"><span class="string">    #迭代的去取该协议中的msg的path</span></span><br><span class="line"><span class="string">    #这里应该是会返回所有路径</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        this_node (node.Node): Current node that is being fuzzed.</span></span><br><span class="line"><span class="string">        path (list of Connection): List of edges along the path to the current one being fuzzed.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Yields:</span></span><br><span class="line"><span class="string">        list of Connection: List of edges along the path to the current one being fuzzed.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># step through every edge from the current node.</span></span><br><span class="line">    <span class="keyword">for</span> edge <span class="keyword">in</span> self.edges_from(this_node.<span class="built_in">id</span>):</span><br><span class="line">        <span class="comment"># keep track of the path as we fuzz through it, don&#x27;t count the root node.</span></span><br><span class="line">        <span class="comment"># we keep track of edges as opposed to nodes because if there is more then one path through a set of</span></span><br><span class="line">        <span class="comment"># given nodes we don&#x27;t want any ambiguity.</span></span><br><span class="line">        path.append(edge)</span><br><span class="line"></span><br><span class="line">        message_path = self._message_path_to_str(path)</span><br><span class="line">        logging.debug(<span class="string">&quot;fuzzing: &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message_path))</span><br><span class="line">        self.fuzz_node = self.nodes[path[-<span class="number">1</span>].dst]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">yield</span> path</span><br><span class="line"></span><br><span class="line">        <span class="comment"># recursively fuzz the remainder of the nodes in the session graph.</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> self._iterate_protocol_message_paths_recursive(self.fuzz_node, path):</span><br><span class="line">            <span class="keyword">yield</span> x</span><br><span class="line"></span><br><span class="line">    <span class="comment"># finished with the last node on the path, pop it off the path stack.</span></span><br><span class="line">    <span class="keyword">if</span> path:</span><br><span class="line">        path.pop()</span><br></pre></td></tr></table></figure>



<h4 id="generate-n-mutations-for-path"><a href="#generate-n-mutations-for-path" class="headerlink" title="_generate_n_mutations_for_path"></a>_generate_n_mutations_for_path</h4><p>知道path如何产生的之后再回去看<code>    MutationContext</code>是怎么产生的，<code>_generate_n_mutations_for_path</code>函数对传进来的path产生<code>mutation_context</code>，<code>mutation_context</code>就是代表这次case的变异体上下文，depth是标识一个<code>fuzz_case</code>使用几个变异体,默认为1。</p>
<p>那么<code>MutationContext</code>的mutations就只有一个<code>qualified_name</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_generate_n_mutations_for_path</span>(<span class="params">self, path, depth</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Yield MutationContext with n mutations for a specific message.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        path (list of Connection): Nodes (Requests) along the path to the current one being fuzzed.</span></span><br><span class="line"><span class="string">        depth (int): Yield sets of depth mutations.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Yields:</span></span><br><span class="line"><span class="string">        MutationContext: A MutationContext containing one mutation.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> mutations <span class="keyword">in</span> self._generate_n_mutations_for_path_recursive(path, depth=depth):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._mutations_contain_duplicate(mutations):</span><br><span class="line">            self.total_mutant_index += <span class="number">1</span></span><br><span class="line">            <span class="keyword">yield</span> MutationContext(message_path=path, mutations=&#123;n.qualified_name: n <span class="keyword">for</span> n <span class="keyword">in</span> mutations&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="generate-n-mutations-for-path-recursive"><a href="#generate-n-mutations-for-path-recursive" class="headerlink" title="_generate_n_mutations_for_path_recursive"></a>_generate_n_mutations_for_path_recursive</h4><p>调用<code>_generate_n_mutations_for_path_recursive</code>产生mutation集合。</p>
<p>mutaions由两个部分组成，一个是<code>_generate_mutations_for_request</code>函数产生的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_generate_n_mutations_for_path_recursive</span>(<span class="params">self, path, depth, skip_elements=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> skip_elements <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        skip_elements = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> depth == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">yield</span> []</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    new_skip = skip_elements.copy()</span><br><span class="line">    <span class="comment"># 调试yield</span></span><br><span class="line">    <span class="comment"># for mutations in self._generate_mutations_for_request(path=path, skip_elements=skip_elements):</span></span><br><span class="line">    <span class="comment">#     print(mutations)</span></span><br><span class="line">    <span class="keyword">for</span> mutations <span class="keyword">in</span> self._generate_mutations_for_request(path=path, skip_elements=skip_elements):</span><br><span class="line">        new_skip.update(m.qualified_name <span class="keyword">for</span> m <span class="keyword">in</span> mutations)</span><br><span class="line">        <span class="keyword">for</span> ms <span class="keyword">in</span> self._generate_n_mutations_for_path_recursive(path, depth=depth - <span class="number">1</span>, skip_elements=new_skip):</span><br><span class="line">            <span class="keyword">yield</span> mutations + ms</span><br></pre></td></tr></table></figure>



<h4 id="generate-mutations-for-request"><a href="#generate-mutations-for-request" class="headerlink" title="_generate_mutations_for_request"></a>_generate_mutations_for_request</h4><p>设置<code>fuzz_node</code>为当前路径上的最后一个node，之后调用<code>fuzz_node</code>的<code>get_mutations</code>，<code>fuzz_node</code>是一个request对象，所以这里调用的是request的<code>get_mutations</code>方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_generate_mutations_for_request</span>(<span class="params">self, path, skip_elements=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Yield each mutation for a specific message (the last message in path).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        path (list of Connection): Nodes (Requests) along the path to the current one being fuzzed.</span></span><br><span class="line"><span class="string">        path (iter of str): Qualified names of elements to skip while fuzzing.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Yields:</span></span><br><span class="line"><span class="string">        Mutation: Mutation object describing a single mutation.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> skip_elements <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        skip_elements = []</span><br><span class="line">    <span class="comment">#这里设置fuzz_node为当前fuzz路径的dst</span></span><br><span class="line">    self.fuzz_node = self.nodes[path[-<span class="number">1</span>].dst]</span><br><span class="line">    self.mutant_index = <span class="number">0</span></span><br><span class="line">    <span class="comment">#调试yield</span></span><br><span class="line">    <span class="comment">#value_list = list(self.fuzz_node.get_mutations(skip_elements=skip_elements))</span></span><br><span class="line">    <span class="comment">#这里会对node里的item枚举产生mutation</span></span><br><span class="line">    <span class="keyword">for</span> mutations <span class="keyword">in</span> self.fuzz_node.get_mutations(skip_elements=skip_elements):</span><br><span class="line">        <span class="comment">#记录整体的已经发生的变异次数</span></span><br><span class="line">        self.mutant_index += <span class="number">1</span></span><br><span class="line">        <span class="keyword">yield</span> mutations</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self._skip_current_node_after_current_test_case:</span><br><span class="line">            self._skip_current_node_after_current_test_case = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> self._skip_current_element_after_current_test_case:</span><br><span class="line">            self.fuzz_node.mutant.stop_mutations()</span><br><span class="line">            self._skip_current_element_after_current_test_case = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>



<h4 id="request-get-mutations"><a href="#request-get-mutations" class="headerlink" title="request.get_mutations"></a>request.get_mutations</h4><p>Request继承自<code>FuzzableBlock</code>，mutations是<code>FuzzableBlock</code>的方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mutations</span>(<span class="params">self, default_value=<span class="literal">None</span>, skip_elements=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> self.mutations(default_value=default_value, skip_elements=skip_elements)</span><br></pre></td></tr></table></figure>



<h4 id="FuzzableBlock-mutations"><a href="#FuzzableBlock-mutations" class="headerlink" title="FuzzableBlock.mutations"></a>FuzzableBlock.mutations</h4><p>遍历当前request的stack中的item，即插入的block和primitive，再调用他们的<code>get_mutations</code>函数得到mutation。</p>
<p>primitives都继承自fuzzable，所以这里调用的是fuzzable的<code>get_mutations</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mutations</span>(<span class="params">self, default_value, skip_elements=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> skip_elements <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        skip_elements = []</span><br><span class="line">    <span class="comment">#遍历stack中的item</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> self.stack:</span><br><span class="line">        <span class="keyword">if</span> item.qualified_name <span class="keyword">in</span> skip_elements:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        self.request.mutant = item</span><br><span class="line">        <span class="keyword">for</span> mutation <span class="keyword">in</span> item.get_mutations():</span><br><span class="line">            <span class="keyword">yield</span> mutation</span><br></pre></td></tr></table></figure>



<h4 id="fuzzable-get-mutations"><a href="#fuzzable-get-mutations" class="headerlink" title="fuzzable.get_mutations"></a>fuzzable.get_mutations</h4><p>这个函数就是对当前item进行变异，并将变异的值传到生成的Mutation里面。</p>
<p>Mutation的构造这里就能看到，是由一个值value，一个所属item的<code>qualified_name</code>，以及变异计数index组成的。</p>
<p>这里终止变异用的是<code>_halt_mutations</code>标志，而<code>stop_mutations</code>函数是提供的接口，其内部就是设置<code>_halt_mutations</code>为true。</p>
<p><code>itertools.chain</code>的功能就是合并列表，所以这里值得来源就为<code>self.mutations(self.original_value())</code>，<code>self._fuzz_values</code>。</p>
<p>其中<code>_fuzz_values</code>在Fuzzable的<em>init</em>函数中是可以作为构造参数传入的，但是String（继承自Fuzzble）的构造函数里并没有这个参数，所以就没找到接口设置这个值(除了手动赋值)，所以这里总是空列表。</p>
<p>下面会以String为例，分析了其mutations函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mutations</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Iterate mutations. Used by boofuzz framework.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Yields:</span></span><br><span class="line"><span class="string">        list of Mutation: Mutations</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.fuzzable:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">        <span class="comment">#value_list = list(itertools.chain(self.mutations(self.original_value()), self._fuzz_values))</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> itertools.chain(self.mutations(self.original_value()), self._fuzz_values):</span><br><span class="line">            <span class="comment">#这里是我自己添加的，当mutate进行200次后，就停止对这个item的mutate，以加速path的遍历，要不然会一直卡在对这一个item的遍历上</span></span><br><span class="line">            <span class="keyword">if</span> index&gt;<span class="number">200</span>:</span><br><span class="line">                self.stop_mutations()</span><br><span class="line">            <span class="keyword">if</span> self._halt_mutations:</span><br><span class="line">                self._halt_mutations = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">list</span>):</span><br><span class="line">                <span class="keyword">yield</span> value</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(value, Mutation):</span><br><span class="line">                <span class="keyword">yield</span> [value]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">yield</span> [Mutation(value=value, qualified_name=self.qualified_name, index=index)]</span><br><span class="line">                index += <span class="number">1</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        self._halt_mutations = <span class="literal">False</span>  <span class="comment"># in case stop_mutations is called when mutations were exhausted anyway</span></span><br></pre></td></tr></table></figure>



<h4 id="stop-mutations"><a href="#stop-mutations" class="headerlink" title="stop_mutations"></a>stop_mutations</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stop_mutations</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Stop yielding mutations on the currently running :py:meth:`mutations` call.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Used by boofuzz to stop fuzzing an element when it&#x27;s already caused several failures.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        NoneType: None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self._halt_mutations = <span class="literal">True</span></span><br></pre></td></tr></table></figure>



<h4 id="String-mutation"><a href="#String-mutation" class="headerlink" title="String.mutation"></a>String.mutation</h4><p>这里进一步可以看到变异值有三个来源：</p>
<p><code>_fuzz_library</code> 可以理解为预置的容易产生crash的字典；</p>
<p><code>_yield_variable_mutations(default_value)</code> 对<code>default_value</code>进行重叠以产生变异值；</p>
<p><code>_yield_long_strings(self.long_string_seeds)</code> 带点随机性的变异，(随机替换字符为终结符)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mutations</span>(<span class="params">self, default_value</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Mutate the primitive by stepping through the fuzz library extended with the &quot;this&quot; library, return False on</span></span><br><span class="line"><span class="string">    completion.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        default_value (str): Default value of element.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Yields:</span></span><br><span class="line"><span class="string">        str: Mutations</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    last_val = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> val <span class="keyword">in</span> itertools.chain(</span><br><span class="line">        self._fuzz_library,</span><br><span class="line">        self._yield_variable_mutations(default_value),</span><br><span class="line">        self._yield_long_strings(self.long_string_seeds),</span><br><span class="line">    ):</span><br><span class="line">        current_val = self._adjust_mutation_for_size(val)</span><br><span class="line">        <span class="keyword">if</span> last_val == current_val:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        last_val = current_val</span><br><span class="line">        <span class="keyword">yield</span> current_val</span><br></pre></td></tr></table></figure>



<h4 id="fuzz-library-只贴了一部分"><a href="#fuzz-library-只贴了一部分" class="headerlink" title="_fuzz_library (只贴了一部分)"></a>_fuzz_library (只贴了一部分)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># store fuzz_library as a class variable to avoid copying the ~70MB structure across each instantiated primitive.</span></span><br><span class="line"><span class="comment"># Has to be sorted to avoid duplicates</span></span><br><span class="line">_fuzz_library = [</span><br><span class="line">    <span class="string">&quot;!@#$%%^#$%#$@#$%$$@#$%^^**(()&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&quot;</span>,  <span class="comment"># strings ripped from spike (and some others I added)</span></span><br><span class="line">    <span class="string">&quot;$(reboot)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;$;reboot&quot;</span>,</span><br><span class="line">    <span class="string">&quot;%00&quot;</span>,</span><br><span class="line">    <span class="string">&quot;%00/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;%01%02%03%04%0a%0d%0aADSF&quot;</span>,</span><br><span class="line">    <span class="string">&quot;%01%02%03@%04%0a%0d%0aADSF&quot;</span>,</span><br><span class="line">    <span class="string">&quot;%0a reboot %0a&quot;</span>,</span><br></pre></td></tr></table></figure>



<h4 id="yield-variable-mutations"><a href="#yield-variable-mutations" class="headerlink" title="_yield_variable_mutations"></a>_yield_variable_mutations</h4><p>重叠产生变异值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_variable_mutation_multipliers = [<span class="number">2</span>, <span class="number">10</span>, <span class="number">100</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_yield_variable_mutations</span>(<span class="params">self, default_value</span>):</span></span><br><span class="line">    <span class="keyword">for</span> length <span class="keyword">in</span> self._variable_mutation_multipliers:</span><br><span class="line">        value = default_value * length</span><br><span class="line">        <span class="keyword">if</span> value <span class="keyword">not</span> <span class="keyword">in</span> self._fuzz_library:</span><br><span class="line">            <span class="keyword">yield</span> value</span><br><span class="line">            <span class="keyword">if</span> self.max_len <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="built_in">len</span>(value) &gt;= self.max_len:</span><br><span class="line">                <span class="keyword">break</span></span><br></pre></td></tr></table></figure>



<h4 id="yield-long-strings"><a href="#yield-long-strings" class="headerlink" title="_yield_long_strings"></a>_yield_long_strings</h4><p>这个函数有两部分，第一部分仍然是采取重叠的策略来产生变异值，只不过seed来自于<code>long_string_seeds</code>。</p>
<p><code>random.sample(list,size)</code>的功能是随机抽样，从list中抽size个数。</p>
<p>第二部分是先按<code>_long_string_lengths</code>中的长度产生一个D*size的字符串，然后再随机将其中的字符替换成/00,这是整个String的变异过程中唯一随机的部分。替换哪些位置的字符是在String初始化时已经按<code>_long_string_lengths</code>中的长度初始化过了（random_indices）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#传进去的sequences</span></span><br><span class="line">long_string_seeds = [<span class="string">&quot;C&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;&quot;&#x27;</span>,<span class="string">&quot;/&quot;</span>,<span class="string">&quot;\\&quot;</span>,<span class="string">&quot;?&quot;</span>,<span class="string">&quot;=&quot;</span>,<span class="string">&quot;a=&quot;</span>,<span class="string">&quot;&amp;&quot;</span>,<span class="string">&quot;.&quot;</span>,<span class="string">&quot;,&quot;</span>,<span class="string">&quot;(&quot;</span>,<span class="string">&quot;)&quot;</span>,<span class="string">&quot;]&quot;</span>,<span class="string">&quot;[&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;-&quot;</span>,<span class="string">&quot;+&quot;</span>,<span class="string">&quot;&#123;&quot;</span>,<span class="string">&quot;&#125;&quot;</span>,<span class="string">&quot;\x14&quot;</span>,<span class="string">&quot;\x00&quot;</span>,<span class="string">&quot;\xFE&quot;</span>,]</span><br><span class="line">_long_string_lengths = [<span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>, <span class="number">64</span>, <span class="number">128</span>, <span class="number">256</span>, <span class="number">512</span>, <span class="number">1024</span>, <span class="number">2048</span>, <span class="number">4096</span>, <span class="number">32768</span>, <span class="number">0xFFFF</span>]</span><br><span class="line">_long_string_deltas = [-<span class="number">2</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">_extra_long_string_lengths = [<span class="number">99999</span>, <span class="number">100000</span>, <span class="number">500000</span>, <span class="number">1000000</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_yield_long_strings</span>(<span class="params">self, sequences</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Given a sequence, yield a number of selectively chosen strings lengths of the given sequence.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @type  sequences: list(str)</span></span><br><span class="line"><span class="string">    @param sequences: Sequence to repeat for creation of fuzz strings.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment">#也是重叠的策略，只不过这里是从long_string_seeds中选出sequence来进行重叠</span></span><br><span class="line">    <span class="keyword">for</span> sequence <span class="keyword">in</span> sequences:</span><br><span class="line">        <span class="comment">#按_long_string_lengths和_long_string_deltas结合产生的长度产生(标准)</span></span><br><span class="line">        <span class="keyword">for</span> size <span class="keyword">in</span> [</span><br><span class="line">            length + delta</span><br><span class="line">            <span class="keyword">for</span> length, delta <span class="keyword">in</span> itertools.product(self._long_string_lengths, self._long_string_deltas)</span><br><span class="line">        ]:</span><br><span class="line">            <span class="keyword">if</span> self.max_len <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> size &lt;= self.max_len:</span><br><span class="line">                data = sequence * math.ceil(size / <span class="built_in">len</span>(sequence))</span><br><span class="line">                <span class="keyword">yield</span> data[:size]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">		<span class="comment">#按_extra_long_string_lengths中的长度产生(额外定义)</span></span><br><span class="line">        <span class="keyword">for</span> size <span class="keyword">in</span> self._extra_long_string_lengths:</span><br><span class="line">            <span class="keyword">if</span> self.max_len <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> size &lt;= self.max_len:</span><br><span class="line">                data = sequence * math.ceil(size / <span class="built_in">len</span>(sequence))</span><br><span class="line">                <span class="keyword">yield</span> data[:size]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">		<span class="comment">#按最大长度产生</span></span><br><span class="line">        <span class="keyword">if</span> self.max_len <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            data = sequence * math.ceil(self.max_len / <span class="built_in">len</span>(sequence))</span><br><span class="line">            <span class="keyword">yield</span> data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> size <span class="keyword">in</span> self._long_string_lengths:</span><br><span class="line">        <span class="keyword">if</span> self.max_len <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> size &lt;= self.max_len:</span><br><span class="line">            s = <span class="string">&quot;D&quot;</span> * size</span><br><span class="line">            <span class="keyword">for</span> loc <span class="keyword">in</span> self.random_indices[size]:</span><br><span class="line">                <span class="keyword">yield</span> s[:loc] + <span class="string">&quot;\x00&quot;</span> + s[loc + <span class="number">1</span> :]  <span class="comment"># Replace character at loc with terminator</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#def  init():</span></span><br><span class="line">        self.random_indices = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        local_random = random.Random(<span class="number">0</span>)  <span class="comment"># We want constant random numbers to generate reproducible test cases</span></span><br><span class="line">        previous_length = <span class="number">0</span></span><br><span class="line">        <span class="comment"># For every length add a random number of random indices to the random_indices dict. Prevent duplicates by</span></span><br><span class="line">        <span class="comment"># adding only indices in between previous_length and current length.</span></span><br><span class="line">        <span class="keyword">for</span> length <span class="keyword">in</span> self._long_string_lengths:</span><br><span class="line">            self.random_indices[length] = local_random.sample(</span><br><span class="line">                <span class="built_in">range</span>(previous_length, length), local_random.randint(<span class="number">1</span>, self._long_string_lengths[<span class="number">0</span>])</span><br><span class="line">            )</span><br><span class="line">            previous_length = length</span><br></pre></td></tr></table></figure>



<h4 id="总结数据变异流程"><a href="#总结数据变异流程" class="headerlink" title="总结数据变异流程"></a>总结数据变异流程</h4><p>一次<code>fuzz_case</code>所用的变异数据来自于<code>mutation_context</code>，<code>mutation_context</code>由<code>message_path</code>和mutations组成。</p>
<p>mutations产生于primitive，对primitive的一次变异产生一个mutation，mutation中包含变异值和所属的primitive的<code>qualified_name</code>。</p>
<p>根据传入的depth的数值，<code>mutation_context</code>可以包含多个mutation，只不过默认值depth为1，因此<code>mutation_context</code>一般就包含一个mutation。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#session._main_fuzz_loop()</span></span><br><span class="line"><span class="keyword">for</span> mutation_context <span class="keyword">in</span> fuzz_case_iterator:</span><br><span class="line">    <span class="keyword">if</span> self.total_mutant_index &lt; self._index_start:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#session._generate_n_mutations_for_path()</span></span><br><span class="line">self.total_mutant_index += <span class="number">1</span></span><br><span class="line"><span class="keyword">yield</span> MutationContext(message_path=path, mutations=&#123;n.qualified_name: n <span class="keyword">for</span> n <span class="keyword">in</span> mutations&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Fuzzable.get_mutations()</span></span><br><span class="line"><span class="keyword">yield</span> [Mutation(value=value, qualified_name=self.qualified_name, index=index)]</span><br></pre></td></tr></table></figure>

<p>变量<code>total_mutant_index</code>标记产生了多少<code>mutation_context</code>，也就等同于<code>fuzz_case</code>的次数。</p>
<p>变量<code>mutant_index</code>标记产生了多少mutant(mutation),在depth为1的情况下，<code>mutant_index</code>就等于<code>total_mutant_index</code>。</p>
<p>而mutation的产生则是首先会遍历出状态图的所有path，然后对path中最后一个node中的item进行变异。</p>
<h3 id="其他细节"><a href="#其他细节" class="headerlink" title="其他细节"></a>其他细节</h3><p>这里再分析下刚才没提到的一些细节，其实整体框架和流程已经分析完了，但是对这些小细节也比较清楚的话，能更好的了解boofuzz。</p>
<h4 id="qualified-name"><a href="#qualified-name" class="headerlink" title="qualified_name"></a>qualified_name</h4><p>我们创建primitive时一般只给个<code>default_value</code>，这样在Fuzzable里，就会默认赋值个name，格式是类型加计数，例如String1,String2。</p>
<p>primitive的<code>context_path</code>是在push的时候赋予的，标记着的是其在request中的位置。</p>
<p>最后<code>qualified_name</code>的产生是将<code>context_path</code>和name拼接在一起。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Fuzzable._init()</span></span><br><span class="line"><span class="keyword">if</span> self._name <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    Fuzzable.name_counter += <span class="number">1</span></span><br><span class="line">    self._name = <span class="string">&quot;&#123;0&#125;&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">type</span>(self).__name__, Fuzzable.name_counter)</span><br><span class="line">    </span><br><span class="line"><span class="comment">#Request.push()</span></span><br><span class="line">item.context_path = self._generate_context_path(self.block_stack)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_generate_context_path</span>(<span class="params">self, block_stack</span>):</span></span><br><span class="line">    context_path = <span class="string">&quot;.&quot;</span>.join(x.name <span class="keyword">for</span> x <span class="keyword">in</span> block_stack)  <span class="comment"># TODO put in method</span></span><br><span class="line">    context_path = <span class="string">&quot;.&quot;</span>.join(<span class="built_in">filter</span>(<span class="literal">None</span>, (self.name, context_path)))</span><br><span class="line">    <span class="keyword">return</span> context_path</span><br><span class="line"><span class="comment">#Fuzzable.qualified_name</span></span><br><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">qualified_name</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Dot-delimited name that describes the request name and the path to the element within the request.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Example: &quot;request1.block1.block2.node1&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;.&quot;</span>.join(s <span class="keyword">for</span> s <span class="keyword">in</span> (self._context_path, self.name) <span class="keyword">if</span> s != <span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="path数据发送"><a href="#path数据发送" class="headerlink" title="path数据发送"></a>path数据发送</h4><p>前面已经介绍了变异值数据产生和数据发送，但是实际上数据产生和数据发送间还有一些细节没分析。</p>
<p>为了贴合网络协议，boofuzz在发送变异数据前，会先把其path上的正常数据先都发送过去，变异mutation都是在path的最后一个node上。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#seesion._fuzz_current_case()</span></span><br><span class="line"><span class="comment">#这里是正常发送message_path最后一条路径前面的路径数据，这里就可以看出boofuzz是按node Fuzz的</span></span><br><span class="line">    <span class="keyword">for</span> e <span class="keyword">in</span> mutation_context.message_path[:-<span class="number">1</span>]:</span><br><span class="line">        prev_node = self.nodes[e.src]</span><br><span class="line">        node = self.nodes[e.dst]</span><br><span class="line">        protocol_session = ProtocolSession(</span><br><span class="line">            previous_message=prev_node,</span><br><span class="line">            current_message=node,</span><br><span class="line">        )</span><br><span class="line">        mutation_context.protocol_session = protocol_session</span><br><span class="line">        callback_data = self._callback_current_node(node=node, edge=e, test_case_context=protocol_session)</span><br><span class="line">        self._fuzz_data_logger.open_test_step(<span class="string">&quot;Transmit Prep Node &#x27;&#123;0&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(node.name))</span><br><span class="line">        self.transmit_normal(target, node, e, callback_data=callback_data,mutation_context=mutation_context)</span><br></pre></td></tr></table></figure>



<h5 id="transmit-normal"><a href="#transmit-normal" class="headerlink" title="transmit_normal"></a>transmit_normal</h5><p>如果<code>callback_data</code>不为空就发送<code>callback_data</code>，否则发送<code>render(mutation_context)</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transmit_normal</span>(<span class="params">self, sock, node, edge, callback_data, mutation_context</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Render and transmit a non-fuzzed node, process callbacks accordingly.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        sock (Target, optional): Socket-like object on which to transmit node</span></span><br><span class="line"><span class="string">        node (pgraph.node.node (Node), optional): Request/Node to transmit</span></span><br><span class="line"><span class="string">        edge (pgraph.edge.edge (pgraph.edge), optional): Edge along the current fuzz path from &quot;node&quot; to next node.</span></span><br><span class="line"><span class="string">        callback_data (bytes): Data from previous callback.</span></span><br><span class="line"><span class="string">        mutation_context (MutationContext): active mutation context</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> callback_data:</span><br><span class="line">        data = callback_data</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data = node.render(mutation_context=mutation_context)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:  <span class="comment"># send</span></span><br><span class="line">        self.targets[<span class="number">0</span>].send(data)</span><br><span class="line">        self.last_send = data</span><br><span class="line">    <span class="keyword">if</span> self._receive_data_after_each_request:</span><br><span class="line">        self.last_recv = self.targets[<span class="number">0</span>].recv()</span><br></pre></td></tr></table></figure>



<h5 id="request-render"><a href="#request-render" class="headerlink" title="request.render"></a>request.render</h5><p>这个函数流程前面也没分析。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render</span>(<span class="params">self, mutation_context=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> self.block_stack:</span><br><span class="line">        <span class="keyword">raise</span> exception.SullyRuntimeError(<span class="string">&quot;UNCLOSED BLOCK: %s&quot;</span> % self.block_stack[-<span class="number">1</span>].qualified_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> self.get_child_data(mutation_context=mutation_context)</span><br></pre></td></tr></table></figure>



<h5 id="request-get-child-data"><a href="#request-get-child-data" class="headerlink" title="request.get_child_data"></a>request.get_child_data</h5><p>这个函数遍历request中的item，来拼接出数据，item基本都继承自Fuzzable(除了Block)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_child_data</span>(<span class="params">self, mutation_context</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Get child or referenced data for this node.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    For blocks that reference other data from the message structure (e.g. size, checksum, blocks). See</span></span><br><span class="line"><span class="string">    FuzzableBlock for an example.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        mutation_context (MutationContext): Mutation context.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        bytes: Child data.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    rendered = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> self.stack:</span><br><span class="line">        rendered += item.render(mutation_context=mutation_context)</span><br><span class="line">    <span class="keyword">return</span> rendered</span><br></pre></td></tr></table></figure>



<h5 id="Fuzzable-render"><a href="#Fuzzable-render" class="headerlink" title="Fuzzable.render"></a>Fuzzable.render</h5><p>调用<code>get_value</code>获取值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render</span>(<span class="params">self, mutation_context=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Render after applying mutation, if applicable.</span></span><br><span class="line"><span class="string">    :type mutation_context: MutationContext</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> self.encode(value=self.get_value(mutation_context=mutation_context),mutation_context=mutation_context)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params">self, value, mutation_context</span>):</span></span><br><span class="line">    <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure>



<h5 id="Fuzzable-get-value"><a href="#Fuzzable-get-value" class="headerlink" title="Fuzzable.get_value"></a>Fuzzable.get_value</h5><p>就是如果当前item在<code>mutation_context</code>的<code>qualified_name</code>中，就返回变异值，否则就返回初始值<code>_default_value</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_value</span>(<span class="params">self, mutation_context=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper method to get the currently applicable value.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This is either the default value, or the active mutation value as dictated by mutation_context.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        mutation_context (MutationContext):</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> mutation_context <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        mutation_context = MutationContext()</span><br><span class="line">    <span class="keyword">if</span> self.qualified_name <span class="keyword">in</span> mutation_context.mutations:</span><br><span class="line">        mutation = mutation_context.mutations[self.qualified_name]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">callable</span>(mutation.value):</span><br><span class="line">            value = mutation.value(self.original_value(test_case_context=mutation_context.protocol_session))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            value = mutation.value</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        value = self.original_value(test_case_context=mutation_context.protocol_session)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure>



<h5 id="original-value"><a href="#original-value" class="headerlink" title="original_value"></a>original_value</h5><p>因为传进来的都是ProtocolSession对象，所以走else分支返回<code>_default_value</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">original_value</span>(<span class="params">self, test_case_context=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Original, non-mutated value of element.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        test_case_context (ProtocolSession): Used to resolve ReferenceValueTestCaseSession type default values.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment">#这个分支不知道什么时候用到</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(self._default_value, ProtocolSessionReference):</span><br><span class="line">        <span class="keyword">if</span> test_case_context <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self._default_value.default_value</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> test_case_context.session_variables[self._default_value.name]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> self._default_value</span><br></pre></td></tr></table></figure>

<p>继续上面数据发送的位置，path上的正常数据发送完之后才会发送变异数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">prev_node = self.nodes[mutation_context.message_path[-<span class="number">1</span>].src]</span><br><span class="line">node = self.nodes[mutation_context.message_path[-<span class="number">1</span>].dst]</span><br><span class="line">protocol_session = ProtocolSession(</span><br><span class="line">    previous_message=prev_node,</span><br><span class="line">    current_message=node,</span><br><span class="line">)</span><br><span class="line">mutation_context.protocol_session = protocol_session</span><br><span class="line"><span class="comment">#这里会调用callback，同时返回一个callback数据</span></span><br><span class="line">callback_data = self._callback_current_node(</span><br><span class="line">    node=self.fuzz_node, edge=mutation_context.message_path[-<span class="number">1</span>], test_case_context=protocol_session</span><br><span class="line">)</span><br><span class="line">self._fuzz_data_logger.open_test_step(<span class="string">&quot;Fuzzing Node &#x27;&#123;0&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(self.fuzz_node.name))</span><br><span class="line"><span class="comment">#进行实际的变异数据发送</span></span><br><span class="line">self.transmit_fuzz(</span><br><span class="line">    target,</span><br><span class="line">    self.fuzz_node,</span><br><span class="line">    mutation_context.message_path[-<span class="number">1</span>],</span><br><span class="line">    callback_data=callback_data,</span><br><span class="line">    mutation_context=mutation_context,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h3><p>boofuzz只提供了三种monitor：</p>
<p>ProcessMonitor大概是和Procman进行rpc通讯来监控；</p>
<p>NetworkMonitor具体用法不太清楚，看doc里说用了wireshark；</p>
<p>CallbackMonitor是默认的Monitor，提供回调函数的功能。</p>
<p>我们一般需要一个监控连接状态的Monitor，如果连接失败则判定为发生了crash，保存crash样本，前面代码中有我实现的简陋的方案。</p>
<h4 id="CallbackMonitor"><a href="#CallbackMonitor" class="headerlink" title="CallbackMonitor"></a>CallbackMonitor</h4><p>这个Monitor是以Monitor的形式提供几种callback，在session的init函数中,是把传进来的callback赋值给<code>CallbackMonitor</code>，这个Monitor也是会默认。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> pre_send_callbacks <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    pre_send_methods = []</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    pre_send_methods = pre_send_callbacks</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> post_test_case_callbacks <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    post_test_case_methods = []</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    post_test_case_methods = post_test_case_callbacks</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> post_start_target_callbacks <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    post_start_target_methods = []</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    post_start_target_methods = post_start_target_callbacks</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> restart_callbacks <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    restart_methods = []</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    restart_methods = restart_callbacks</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">self._callback_monitor = CallbackMonitor(</span><br><span class="line">    on_pre_send=pre_send_methods,</span><br><span class="line">    on_post_send=post_test_case_methods,</span><br><span class="line">    on_restart_target=restart_methods,</span><br><span class="line">    on_post_start_target=post_start_target_methods,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> target <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">apply_options</span>(<span class="params">monitor</span>):</span></span><br><span class="line">                monitor.set_options(crash_filename=self._crash_filename)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            target.monitor_alive.append(apply_options)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.add_target(target)</span><br><span class="line">            <span class="keyword">except</span> exception.BoofuzzRpcError <span class="keyword">as</span> e:</span><br><span class="line">                self._fuzz_data_logger.log_error(<span class="built_in">str</span>(e))</span><br><span class="line">                <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>

<p>前面回调函数都是用的target的monitor的回调，在session的init中首先设置了<code>_callback_monitor</code>为刚才创建的<code>CallbackMonitor</code>，其给target设置的有些隐蔽，是在<code>add_target</code>中设置的。</p>
<h5 id="add-target"><a href="#add-target" class="headerlink" title="add_target"></a>add_target</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_target</span>(<span class="params">self, target</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Add a target to the session. Multiple targets can be added for parallel fuzzing.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        target (Target): Target to add to session</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># pass specified target parameters to the PED-RPC server.</span></span><br><span class="line">    target.monitors_alive()</span><br><span class="line">    target.set_fuzz_data_logger(fuzz_data_logger=self._fuzz_data_logger)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self._callback_monitor <span class="keyword">not</span> <span class="keyword">in</span> target.monitors:</span><br><span class="line">        target.monitors.append(self._callback_monitor)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add target to internal list.</span></span><br><span class="line">    self.targets.append(target)</span><br></pre></td></tr></table></figure>



<h5 id="pre-send-1"><a href="#pre-send-1" class="headerlink" title="pre_send"></a>pre_send</h5><p>以<code>CallbackMonitor</code>的<code>pre_send</code>为例，可以看到其遍历<code>on_pre_send</code>函数来调用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pre_send</span>(<span class="params">self, target=<span class="literal">None</span>, fuzz_data_logger=<span class="literal">None</span>, session=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;This method iterates over all supplied pre send callbacks and executes them.</span></span><br><span class="line"><span class="string">    Their return values are discarded, exceptions are catched and logged, but otherwise</span></span><br><span class="line"><span class="string">    discarded.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> self.on_pre_send:</span><br><span class="line">            fuzz_data_logger.open_test_step(<span class="string">&#x27;Pre_Send callback: &quot;&#123;0&#125;&quot;&#x27;</span>.<span class="built_in">format</span>(f.__name__))</span><br><span class="line">            f(target=target, fuzz_data_logger=fuzz_data_logger, session=session, sock=target)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        fuzz_data_logger.log_error(</span><br><span class="line">            constants.ERR_CALLBACK_FUNC.<span class="built_in">format</span>(func_name=<span class="string">&quot;pre_send&quot;</span>) + traceback.format_exc()</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>



<h3 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h3><p><a target="_blank" rel="noopener" href="https://x1aor0.github.io/2022/01/14/BoofuzzDoc/">Boofuzz分析</a></p>
<p><a target="_blank" rel="noopener" href="https://boofuzz.readthedocs.io/en/stable/index.html">boofuzz 0.4.0 documentation</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1626/">IoT设备固件分析之网络协议 fuzz (seebug.org)</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">银河</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://yingyingmonstre.github.io/2022/03/22/Boofuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">https://yingyingmonstre.github.io/2022/03/22/Boofuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yingyingmonstre.github.io" target="_blank">银河之家</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/yingyingmonstre.github.io/tags/Fuzzing/">Fuzzing</a></div><div class="post_share"><div class="social-share" data-image="https://p0.ssl.qhimg.com/t01f9ade5a46c467768.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/yingyingmonstre.github.io/2022/08/09/gym/"><img class="prev-cover" src="https://p5.itc.cn/q_70/images03/20210907/009c3bc169044886b93eb23f87b3c444.png" onerror="onerror=null;src='/yingyingmonstre.github.io/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">OpenAI的Gym</div></div></a></div><div class="next-post pull-right"><a href="/yingyingmonstre.github.io/2021/12/24/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3%E4%BB%80%E4%B9%88%E6%98%AFLLVM/"><img class="next-cover" src="http://www.linuxeden.com/wp-content/uploads/2018/04/080803_sN2j_2720166.jpg" onerror="onerror=null;src='/yingyingmonstre.github.io/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">深入浅出理解什么是LLVM</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/yingyingmonstre.github.io/img/avatar.jpg" onerror="this.onerror=null;this.src='/yingyingmonstre.github.io/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">银河</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/yingyingmonstre.github.io/archives/"><div class="headline">文章</div><div class="length-num">6</div></a></div><div class="card-info-data-item is-center"><a href="/yingyingmonstre.github.io/tags/"><div class="headline">标签</div><div class="length-num">5</div></a></div><div class="card-info-data-item is-center"><a href="/yingyingmonstre.github.io/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/YingYingMonstre"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Boofuzz%E6%A0%B7%E4%BE%8B"><span class="toc-number">1.</span> <span class="toc-text">Boofuzz样例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Connection"><span class="toc-number">2.</span> <span class="toc-text">Connection</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#python%E5%85%83%E7%B1%BB%E7%BC%96%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">python元类编程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCPSocketConnection"><span class="toc-number">2.2.</span> <span class="toc-text">TCPSocketConnection</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#open"><span class="toc-number">2.2.1.</span> <span class="toc-text">open</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#open-socket%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.2.</span> <span class="toc-text">open_socket函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#connect-socket%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.3.</span> <span class="toc-text">connect_socket函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#send"><span class="toc-number">2.2.4.</span> <span class="toc-text">send</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#recv"><span class="toc-number">2.2.5.</span> <span class="toc-text">recv</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Target"><span class="toc-number">3.</span> <span class="toc-text">Target</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Session-Logger%E9%83%A8%E5%88%86"><span class="toc-number">4.</span> <span class="toc-text">Session Logger部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-number">5.</span> <span class="toc-text">数据格式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#s-initialize"><span class="toc-number">5.1.</span> <span class="toc-text">s_initialize</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Session-init"><span class="toc-number">5.2.</span> <span class="toc-text">Session.init</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#s-get%E3%80%81s-switch"><span class="toc-number">5.3.</span> <span class="toc-text">s_get、s_switch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#connect"><span class="toc-number">5.4.</span> <span class="toc-text">connect</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#s-string"><span class="toc-number">5.5.</span> <span class="toc-text">s_string</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Request-push"><span class="toc-number">5.6.</span> <span class="toc-text">Request.push</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#block"><span class="toc-number">5.7.</span> <span class="toc-text">block</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#startend%E6%96%B9%E5%BC%8F"><span class="toc-number">5.7.1.</span> <span class="toc-text">startend方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#with%E6%96%B9%E5%BC%8F"><span class="toc-number">5.7.2.</span> <span class="toc-text">with方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#start-fuzz"><span class="toc-number">6.</span> <span class="toc-text">start fuzz</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fuzz"><span class="toc-number">6.1.</span> <span class="toc-text">fuzz</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#main-fuzz-loop"><span class="toc-number">6.2.</span> <span class="toc-text">_main_fuzz_loop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#start-target"><span class="toc-number">6.3.</span> <span class="toc-text">_start_target</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fuzz-current-case"><span class="toc-number">6.4.</span> <span class="toc-text">_fuzz_current_case</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#open-connection-keep-trying"><span class="toc-number">6.5.</span> <span class="toc-text">_open_connection_keep_trying</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pre-send"><span class="toc-number">6.6.</span> <span class="toc-text">_pre_send</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#callback-current-node"><span class="toc-number">6.7.</span> <span class="toc-text">_callback_current_node</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#check-for-passively-detected-failures"><span class="toc-number">6.8.</span> <span class="toc-text">_check_for_passively_detected_failures</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#transmit-fuzz"><span class="toc-number">6.9.</span> <span class="toc-text">transmit_fuzz</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#crash-dump"><span class="toc-number">6.10.</span> <span class="toc-text">crash dump</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8F%98%E5%BC%82"><span class="toc-number">7.</span> <span class="toc-text">数据变异</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#generate-mutations-indefinitely"><span class="toc-number">7.1.</span> <span class="toc-text">_generate_mutations_indefinitely</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#generate-n-mutations"><span class="toc-number">7.2.</span> <span class="toc-text">_generate_n_mutations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#iterate-protocol-message-paths"><span class="toc-number">7.3.</span> <span class="toc-text">_iterate_protocol_message_paths</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#iterate-protocol-message-paths-recursive"><span class="toc-number">7.4.</span> <span class="toc-text">_iterate_protocol_message_paths_recursive</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#generate-n-mutations-for-path"><span class="toc-number">7.5.</span> <span class="toc-text">_generate_n_mutations_for_path</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#generate-n-mutations-for-path-recursive"><span class="toc-number">7.6.</span> <span class="toc-text">_generate_n_mutations_for_path_recursive</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#generate-mutations-for-request"><span class="toc-number">7.7.</span> <span class="toc-text">_generate_mutations_for_request</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#request-get-mutations"><span class="toc-number">7.8.</span> <span class="toc-text">request.get_mutations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FuzzableBlock-mutations"><span class="toc-number">7.9.</span> <span class="toc-text">FuzzableBlock.mutations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fuzzable-get-mutations"><span class="toc-number">7.10.</span> <span class="toc-text">fuzzable.get_mutations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#stop-mutations"><span class="toc-number">7.11.</span> <span class="toc-text">stop_mutations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#String-mutation"><span class="toc-number">7.12.</span> <span class="toc-text">String.mutation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fuzz-library-%E5%8F%AA%E8%B4%B4%E4%BA%86%E4%B8%80%E9%83%A8%E5%88%86"><span class="toc-number">7.13.</span> <span class="toc-text">_fuzz_library (只贴了一部分)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yield-variable-mutations"><span class="toc-number">7.14.</span> <span class="toc-text">_yield_variable_mutations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yield-long-strings"><span class="toc-number">7.15.</span> <span class="toc-text">_yield_long_strings</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E6%95%B0%E6%8D%AE%E5%8F%98%E5%BC%82%E6%B5%81%E7%A8%8B"><span class="toc-number">7.16.</span> <span class="toc-text">总结数据变异流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%BB%86%E8%8A%82"><span class="toc-number">8.</span> <span class="toc-text">其他细节</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#qualified-name"><span class="toc-number">8.1.</span> <span class="toc-text">qualified_name</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#path%E6%95%B0%E6%8D%AE%E5%8F%91%E9%80%81"><span class="toc-number">8.2.</span> <span class="toc-text">path数据发送</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#transmit-normal"><span class="toc-number">8.2.1.</span> <span class="toc-text">transmit_normal</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#request-render"><span class="toc-number">8.2.2.</span> <span class="toc-text">request.render</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#request-get-child-data"><span class="toc-number">8.2.3.</span> <span class="toc-text">request.get_child_data</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Fuzzable-render"><span class="toc-number">8.2.4.</span> <span class="toc-text">Fuzzable.render</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Fuzzable-get-value"><span class="toc-number">8.2.5.</span> <span class="toc-text">Fuzzable.get_value</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#original-value"><span class="toc-number">8.2.6.</span> <span class="toc-text">original_value</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Monitor"><span class="toc-number">9.</span> <span class="toc-text">Monitor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CallbackMonitor"><span class="toc-number">9.1.</span> <span class="toc-text">CallbackMonitor</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#add-target"><span class="toc-number">9.1.1.</span> <span class="toc-text">add_target</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pre-send-1"><span class="toc-number">9.1.2.</span> <span class="toc-text">pre_send</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Refs"><span class="toc-number">10.</span> <span class="toc-text">Refs</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/yingyingmonstre.github.io/2022/08/09/Gym%E7%8E%AF%E5%A2%83%E5%88%9B%E5%BB%BA/" title="Gym环境创建"><img src="https://p5.itc.cn/q_70/images03/20210907/009c3bc169044886b93eb23f87b3c444.png" onerror="this.onerror=null;this.src='/yingyingmonstre.github.io/img/404.jpg'" alt="Gym环境创建"/></a><div class="content"><a class="title" href="/yingyingmonstre.github.io/2022/08/09/Gym%E7%8E%AF%E5%A2%83%E5%88%9B%E5%BB%BA/" title="Gym环境创建">Gym环境创建</a><time datetime="2022-08-09T08:07:00.000Z" title="发表于 2022-08-09 16:07:00">2022-08-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/yingyingmonstre.github.io/2022/08/09/gym/" title="OpenAI的Gym"><img src="https://p5.itc.cn/q_70/images03/20210907/009c3bc169044886b93eb23f87b3c444.png" onerror="this.onerror=null;this.src='/yingyingmonstre.github.io/img/404.jpg'" alt="OpenAI的Gym"/></a><div class="content"><a class="title" href="/yingyingmonstre.github.io/2022/08/09/gym/" title="OpenAI的Gym">OpenAI的Gym</a><time datetime="2022-08-09T08:00:00.000Z" title="发表于 2022-08-09 16:00:00">2022-08-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/yingyingmonstre.github.io/2022/03/22/Boofuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Boofuzz源码分析"><img src="https://p0.ssl.qhimg.com/t01f9ade5a46c467768.png" onerror="this.onerror=null;this.src='/yingyingmonstre.github.io/img/404.jpg'" alt="Boofuzz源码分析"/></a><div class="content"><a class="title" href="/yingyingmonstre.github.io/2022/03/22/Boofuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Boofuzz源码分析">Boofuzz源码分析</a><time datetime="2022-03-22T02:00:00.000Z" title="发表于 2022-03-22 10:00:00">2022-03-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/yingyingmonstre.github.io/2021/12/24/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3%E4%BB%80%E4%B9%88%E6%98%AFLLVM/" title="深入浅出理解什么是LLVM"><img src="http://www.linuxeden.com/wp-content/uploads/2018/04/080803_sN2j_2720166.jpg" onerror="this.onerror=null;this.src='/yingyingmonstre.github.io/img/404.jpg'" alt="深入浅出理解什么是LLVM"/></a><div class="content"><a class="title" href="/yingyingmonstre.github.io/2021/12/24/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3%E4%BB%80%E4%B9%88%E6%98%AFLLVM/" title="深入浅出理解什么是LLVM">深入浅出理解什么是LLVM</a><time datetime="2021-12-24T04:00:00.000Z" title="发表于 2021-12-24 12:00:00">2021-12-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/yingyingmonstre.github.io/2021/11/03/MacBook%20Air%20M1%E5%AE%89%E8%A3%85gym%E9%97%AE%E9%A2%98/" title="MacBook Air M1安装gym问题汇总"><img src="https://img.siemens-home.cn/uploadimg/image/20211103/20211103112735_31910.png" onerror="this.onerror=null;this.src='/yingyingmonstre.github.io/img/404.jpg'" alt="MacBook Air M1安装gym问题汇总"/></a><div class="content"><a class="title" href="/yingyingmonstre.github.io/2021/11/03/MacBook%20Air%20M1%E5%AE%89%E8%A3%85gym%E9%97%AE%E9%A2%98/" title="MacBook Air M1安装gym问题汇总">MacBook Air M1安装gym问题汇总</a><time datetime="2021-11-03T04:00:00.000Z" title="发表于 2021-11-03 12:00:00">2021-11-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022  <i id="heartbeat" class="fa fas fa-heartbeat"></i> 银河</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/yingyingmonstre.github.io/js/utils.js"></script><script src="/yingyingmonstre.github.io/js/main.js"></script><script src="/yingyingmonstre.github.io/js/search/local-search.js"></script><div class="js-pjax"></div><script src="js/custom.js"></script><script src="../js/custom.js"></script><script src="../../js/custom.js"></script><script src="../../../../js/custom.js"></script></div></body></html>